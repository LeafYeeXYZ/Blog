---
title: React/Solidå­¦ä¹ ç¬”è®°
comment: true
excerpt: false
date: 2024-03-18 20:25:46
categories: ç¬”è®°
tags: [Note,React,Coding,Javascript,HTML,CSS]
cover: "/images/cover/react.jpeg"
---
**å°é¢ä½œè€…:[NOEYEBROW](https://x.com/noeyebrow313)**

**è¯·å…ˆé˜…è¯»[JavaScriptå­¦ä¹ ç¬”è®°](/2024/01/17/JavaScript/)**

# &#x2B50;React
`React` æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºç”¨æˆ·ç•Œé¢çš„å¼€æº `JavaScript` åº“, ç”± `Facebook` å¼€å‘å’Œç»´æŠ¤; ä½¿ç”¨ `pnpm create vite` åˆ›å»ºé¡¹ç›®æ—¶, å¯ä»¥é€‰æ‹© `React` æ¨¡æ¿

`React` åº”ç”¨ç¨‹åºç”±ä¸€ä¸ªä¸ª**ç»„ä»¶**æ„æˆ, ä¸€ä¸ªç»„ä»¶å°±æ˜¯ä¸€ä¸ªè¿”å› `JSX` å…ƒç´ çš„ `JavaScript` å‡½æ•° (ä¸ºäº†ä¸ `HTML` æ ‡ç­¾åŒºåˆ†, **å¿…é¡»**ç”¨å¤§å†™å­—æ¯å¼€å¤´çš„å‡½æ•°å)

`JSX` æ˜¯ä¸€ç§ `JavaScript` è¯­æ³•æ‰©å±•, å¯ä»¥åœ¨ `JavaScript` ä¸­ç¼–å†™ç±»ä¼¼ `HTML` çš„ä»£ç , ç”¨äºæè¿°ç”¨æˆ·ç•Œé¢; å®é™…ä¸Š, `JSX` æ˜¯ `React.createElement` å‡½æ•°çš„è¯­æ³•ç³–

```jsx
// App.jsx
export default function App() {
  return ( // å¤šè¡Œ JSX å¿…é¡»ç”¨æ‹¬å·åŒ…è£¹
    <div>
      <h1>Hello, React!</h1>
      <Button />
    </div>
  )
}

function Button() {
  return <button>Click me</button>
}
```

- ä¸å¯ä»¥åœ¨ç»„ä»¶å†…éƒ¨å®šä¹‰ç»„ä»¶ (ä¼šå¾ˆæ…¢ä¸”æœ‰ `bug`)
- ç”±äºä¸€ä¸ªç»„ä»¶å°±æ˜¯ä¸€ä¸ªå‡½æ•°, æ‰€ä»¥æŒ‰ç…§ä¸€èˆ¬ `ES Module` çš„è§„èŒƒè¿›è¡Œæ¨¡å—åŒ–å³å¯
- **ç»„ä»¶å‡½æ•°åº”æ˜¯çº¯å‡½æ•°**: åªè´Ÿè´£è‡ªå·±çš„ä»»åŠ¡ (ä¸ä¿®æ”¹å‡½æ•°ä½œç”¨åŸŸå¤–å¯¹è±¡), è¾“å…¥ç›¸åŒåˆ™è¾“å‡ºç›¸åŒ (ç±»ä¼¼äºæ•°å­¦å…¬å¼)<br>**å‰¯ä½œç”¨**: ä¸æ¸²æŸ“è¿‡ç¨‹æ— å…³çš„æ“ä½œ, å¦‚ç½‘ç»œè¯·æ±‚ã€å®šæ—¶å™¨ç­‰<br>å‰¯ä½œç”¨é€šå¸¸å±äºäº‹ä»¶å¤„ç†å‡½æ•°, å› æ­¤äº‹ä»¶å¤„ç†å‡½æ•°ä¸å¿…æ˜¯çº¯å‡½æ•°<br>å¦‚æœä¸€å®šè¦åœ¨æ¸²æŸ“å‡½æ•°ä¸­æ‰§è¡Œå‰¯ä½œç”¨, å¯ä»¥ä½¿ç”¨ `useEffect` æ–¹æ³• (å‘Šè¯‰ `React` ç»„ä»¶éœ€è¦åœ¨æ¸²æŸ“åæ‰§è¡ŒæŸäº›æ“ä½œ)

#### JSX
- `JSX` æ¯” `HTML` æ›´ä¸¥æ ¼:
  1. **å•æ ‡ç­¾å¿…é¡»é—­åˆ** (å¦‚ `<br />`)
  2. **ä¸€ä¸ªç»„ä»¶åªèƒ½è¿”å›ä¸€ä¸ªæ ‡ç­¾** (å¯ä»¥ç”¨ `<div></div>` æˆ– `<></>` åŒ…è£¹, å…¶ä¸­ `<></>` ä¸ä¼šåœ¨ `DOM` ç”Ÿæˆé¢å¤–èŠ‚ç‚¹)
  1. **ä½¿ç”¨å°é©¼å³°å‘½åæ³•å‘½åå±æ€§** (å¦‚ `className`ã€`onClick`, ä½† `data-*` ä¾‹å¤–)
  2. **é€šè¿‡ `{}` æ’å…¥ `JavaScript` è¡¨è¾¾å¼** (åªèƒ½åœ¨æ ‡ç­¾å†…æ–‡æœ¬æˆ–å±æ€§çš„ `={xxx}` ä¸­ä½¿ç”¨)
  3. ä¸ºé¿å…ä¸ `JavaScript` å…³é”®å­—å†²çª, `JSX` ä¸­çš„ `class` å’Œ `for` å±æ€§åˆ†åˆ«ç”¨ `className` å’Œ `htmlFor` ä»£æ›¿
- å¯ä»¥ä½¿ç”¨[è½¬æ¢å·¥å…·](https://transform.tools/html-to-jsx)å°† `HTML` è½¬æ¢ä¸º `JSX`

#### æ¸²æŸ“æ ‘å’Œä¾èµ–æ ‘
- **æ ‘**æ˜¯è¡¨ç¤ºå®ä½“ä¹‹é—´å…³ç³»çš„å¸¸è§æ–¹å¼ï¼Œå®ƒä»¬ç»å¸¸ç”¨äºå»ºæ¨¡ `UI`
- **æ¸²æŸ“æ ‘**è¡¨ç¤ºå•æ¬¡æ¸²æŸ“ä¸­ `React` ç»„ä»¶ä¹‹é—´çš„åµŒå¥—å…³ç³»
- ä½¿ç”¨æ¡ä»¶æ¸²æŸ“ï¼Œæ¸²æŸ“æ ‘å¯èƒ½ä¼šåœ¨ä¸åŒçš„æ¸²æŸ“è¿‡ç¨‹ä¸­å‘ç”Ÿå˜åŒ–; ä½¿ç”¨ä¸åŒçš„å±æ€§å€¼ï¼Œç»„ä»¶å¯èƒ½ä¼šæ¸²æŸ“ä¸åŒçš„å­ç»„ä»¶
- æ¸²æŸ“æ ‘æœ‰åŠ©äºè¯†åˆ«é¡¶çº§ç»„ä»¶å’Œå¶å­ç»„ä»¶; é¡¶çº§ç»„ä»¶ä¼šå½±å“å…¶ä¸‹æ‰€æœ‰ç»„ä»¶çš„æ¸²æŸ“æ€§èƒ½ï¼Œè€Œå¶å­ç»„ä»¶é€šå¸¸ä¼šé¢‘ç¹é‡æ–°æ¸²æŸ“; è¯†åˆ«å®ƒä»¬æœ‰åŠ©äºç†è§£å’Œè°ƒè¯•æ¸²æŸ“æ€§èƒ½é—®é¢˜
- **ä¾èµ–æ ‘**è¡¨ç¤º `React` åº”ç”¨ç¨‹åºä¸­çš„æ¨¡å—ä¾èµ–å…³ç³»
- æ„å»ºå·¥å…·ä½¿ç”¨ä¾èµ–æ ‘æ¥æ†ç»‘å¿…è¦çš„ä»£ç ä»¥éƒ¨ç½²åº”ç”¨ç¨‹åº
- ä¾èµ–æ ‘æœ‰åŠ©äºè°ƒè¯•å¤§å‹æ†ç»‘åŒ…å¸¦æ¥çš„æ¸²æŸ“é€Ÿåº¦è¿‡æ…¢çš„é—®é¢˜ï¼Œä»¥åŠå‘ç°å“ªäº›æ†ç»‘ä»£ç å¯ä»¥è¢«ä¼˜åŒ–

| æ¸²æŸ“æ ‘ | ä¾èµ–æ ‘ |
| :---: | :---: |
| ![æ¸²æŸ“æ ‘](/images/note/render_tree.webp) | ![ä¾èµ–æ ‘](/images/note/module_dependency_tree.webp) |

#### å¼•å…¥ç°æœ‰é¡¹ç›®
æ³¨æ„, åº”ç”¨çš„æ‰“åŒ…å·¥å…·å¿…é¡»æ”¯æŒ `ES Module`, å¦‚ `Webpack`ã€`Vite`ã€`Parcel` ç­‰

```bash
# å®‰è£… React
npm install react react-dom
```

```html
<!-- ç»™ React ç»„ä»¶ä¸€ä¸ªå®¹å™¨ -->
<div id="count"></div>
```

```javascript
// å¼•å…¥ React
import { createRoot } from 'react-dom/client'
import React, { useState } from 'react'
// å®šä¹‰ç»„ä»¶
function Counter() {
  const [count, setCount] = useState(0)
  function handleClick() setCount(count + 1)
  return <button onClick={handleClick}>ç‚¹å‡»æ¬¡æ•°: {count}</button>
}
// åˆ›å»ºè™šæ‹Ÿ DOM
const root = createRoot(document.querySelector('#count'))
// æ¸²æŸ“ç»„ä»¶
root.render(<Counter />)
```

> **è™šæ‹Ÿ `DOM`** æ˜¯ `React` çš„æ ¸å¿ƒ, ç”¨äºæè¿° `DOM` ç»“æ„, å½“ `state` å‘ç”Ÿå˜åŒ–æ—¶, `React` ä¼šæ¯”è¾ƒæ–°æ—§ `DOM` ç»“æ„, ä»…æ›´æ–°éœ€è¦æ›´æ–°çš„éƒ¨åˆ†, ä»¥æé«˜æ€§èƒ½

## Component
{% notel green æœ¬æ®µå¯¼èˆª %}
{% btn æ·»åŠ æ•°æ®::#æ·»åŠ æ•°æ® %} {% btn æ¡ä»¶æ¸²æŸ“::#æ¡ä»¶æ¸²æŸ“ %} {% btn åˆ—è¡¨æ¸²æŸ“::#åˆ—è¡¨æ¸²æŸ“ %} {% btn å“åº”äº‹ä»¶::#å“åº”äº‹ä»¶ %} {% btn äº‹ä»¶å†’æ³¡::#äº‹ä»¶å†’æ³¡ %} {% btn `<Suspense>`::#Suspense %}
{% endnotel %}

#### æ·»åŠ æ•°æ®
```jsx
const user = {name: 'å°å¶å­', age: 18, class: 'psychology'}
const userStyle = {color: 'red', fontSize: '20px'}
function UserInfo() {
  return (
    <div
      className={user.class} // ä»å¯¹è±¡ä¸­è·å–å±æ€§æ·»åŠ ç±»å
      style={
        ...userStyle, // ä½¿ç”¨å±•å¼€è¿ç®—ç¬¦åˆå¹¶æ ·å¼
        fontWeight: 'bold' // ä½¿ç”¨é©¼å³°å‘½åæ³•
      }
    >
      <h2>{user.name}</h2>
      <p>{user.age >= 18 ? 'æˆå¹´' : 'æœªæˆå¹´'}</p> // ä½¿ç”¨ä¸‰å…ƒè¿ç®—ç¬¦
    </div>
  )
}
```

> æ³¨æ„: æ ·å¼å¿…é¡»ç”¨å°é©¼å³°å‘½åæ³• (`JavaScript` çš„å˜é‡åä¸èƒ½æœ‰ `-`)

#### æ¡ä»¶æ¸²æŸ“
```jsx
function GreenButton() {
  return <button style={{color: 'green'}}>Click me</button>
}
function RedButton() {
  return <button style={{color: 'red'}}>Click me</button>
}

const user = { name: 'å°å¶å­', age: 18 }
function Button() {
  return (
    <div> // ä¸‰å…ƒè¿ç®—ç¬¦å®ç°æ¡ä»¶æ¸²æŸ“
      {user.age >= 18 ? <GreenButton /> : ( user.age > 12 ? <RedButton /> : null )}
    </div>
  )
}
```

> ç»„ä»¶åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¸éœ€è¦è¿”å›ä»»ä½•å†…å®¹, æ­¤æ—¶å¯ä»¥è¿”å› `null`

#### åˆ—è¡¨æ¸²æŸ“
```jsx
const list = ['apple', 'banana', 'cherry']
// ä½¿ç”¨ map æ–¹æ³•å°†åˆ—è¡¨è½¬æ¢ä¸º JSX å…ƒç´ æ•°ç»„
const listItems = list.map(
  (item, index) => <li key={index}>{item}</li>
)
function List() {
  return <ul>{listItems}</ul>
}
```

- åˆ—è¡¨æ¸²æŸ“æ—¶, éœ€è¦ä¸ºæ¯ä¸ªå­å…ƒç´ æ·»åŠ ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„ `key` å±æ€§, ç”¨äºå¸®åŠ© `React` è¯†åˆ«åˆ—è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ 
- é€šå¸¸ä½¿ç”¨æ¥è‡ªæ•°æ®åº“çš„å”¯ä¸€ `id` ä½œä¸º `key` (å¦‚ `MongoDB` çš„ `_id`)
- æœ¬åœ°æ•°æ®å¯ä»¥ä½¿ç”¨ä¸€ä¸ªè‡ªå¢è®¡æ•°å™¨æˆ–è€… `uuid` ä½œä¸º `key`
- **`key` çš„å€¼åªéœ€åœ¨å…„å¼ŸèŠ‚ç‚¹ä¸­ä¿æŒå”¯ä¸€å³å¯**, æ‰€ä»¥å¯ä»¥ä½¿ç”¨ `index` ä½œä¸º `key`

#### å“åº”äº‹ä»¶
```jsx
function Button() {
  function handleClick() {
    alert('Hello, React!')
  } // äº‹ä»¶å¤„ç†å‡½æ•°é€šå¸¸åœ¨ç»„ä»¶å†…éƒ¨å®šä¹‰
  return <button onClick={handleClick}>Click me</button>
}
```

#### äº‹ä»¶å†’æ³¡
é™¤ `onScroll` å¤–çš„æ‰€æœ‰äº‹ä»¶éƒ½ä¼šå†’æ³¡, é™¤éä½¿ç”¨ `event.stopPropagation()` é˜»æ­¢å†’æ³¡

```jsx
function Button(props) {
  return ( // åœ¨å›è°ƒå‡½æ•°ä¸­å†™äº† event.preventDefault()
    <button onClick={props.onClick}>
      Click me
    </button>
  )
}

// ä¹Ÿå¯ä»¥ä¸åœ¨å›è°ƒå‡½æ•°ä¸­å†™ event.preventDefault()
// è¿™æ ·ä¼šæ¯”è¾ƒçµæ´»
function Button(props) {
  return (
    <button onClick={e => {
      e.preventDefault()
      props.onClick()
    }}>
      Click me
    </button>
  )
}
```

#### \<Suspense\> <span id='Suspense'></span>
`<Suspense>` ç»„ä»¶ç”¨äºåœ¨åŠ è½½ç»„ä»¶æ—¶æ˜¾ç¤ºä¸€ä¸ªåŠ è½½æŒ‡ç¤ºå™¨, ä»¥é¿å…æ˜¾ç¤ºç©ºç™½é¡µé¢

```tsx
import { Suspense } from 'react'

<Suspense fallback={<Loading />}>
  <SomeComponent />
</Suspense>
```

## Props
`props` æ˜¯ç»„ä»¶çš„å±æ€§, ç”¨äºæ¥æ”¶çˆ¶ç»„ä»¶ä¼ é€’çš„æ•°æ®, æ˜¯**åªè¯»**çš„

```jsx
import { useState } from 'react'

// åœ¨çˆ¶å…ƒç´ ä¸­å®šä¹‰ state
function App() {
  const [count, setCount] = useState(0)
  function handleClick() {
    setCount(count + 1)
  }

  return (
    <div>
      <Counter count={count} onClick={handleClick} />
      <Counter count={count} onClick={handleClick} />
    </div>
  )
}

// å­ç»„ä»¶æ¥æ”¶ props
function Counter({ count, onClick }) {
  return (
    <div>
      <button onClick={onClick}>ç‚¹å‡»æ¬¡æ•°: {count}</button>
    </div>
  )
}
```

- åœ¨ `JSX` çš„ `HTML` æ ‡ç­¾ä¸­, å±æ€§å®é™…ä¸Šä¹Ÿæ˜¯ `props`, å¦‚ `<img src="xxx" alt="xxx" />` ä¸­çš„ `src` å’Œ `alt` å°±æ˜¯ `props` å¯¹è±¡çš„å±æ€§
- `<Counter count={count} onClick={handleClick} />` ä¸­çš„ `count` å’Œ `onClick` æ˜¯ `props` å¯¹è±¡çš„å±æ€§å, å¹¶ä¸ä¼šç›´æ¥ä½œç”¨äºå­ç»„ä»¶
- `props` å¯¹è±¡æ˜¯å­ç»„ä»¶å‡½æ•°çš„å”¯ä¸€å‚æ•° (å¯é€šè¿‡è§£æ„èµ‹å€¼è·å–å†…éƒ¨å…ƒç´ )
- `props` ä¹Ÿå¯ä»¥åƒå‡½æ•°å½¢å‚é‚£æ ·æœ‰é»˜è®¤å€¼, å¦‚ `function Counter({ count = 0, onClick })`

#### props.children
`props.children` æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ `prop`, ç”¨äºæ¥æ”¶ç»„ä»¶çš„å­å…ƒç´ 

```jsx
function Card({ title, children }) {
  return (
    <div>
      <h2>{title}</h2>
      <div>{children}</div>
    </div>
  )
}

function Counter() {
  const [count, setCount] = useState(0)
  function handleClick() {
    setCount(count + 1)
  }
  return <button onClick={handleClick}>ç‚¹å‡»æ¬¡æ•°: {count}</button>
}

export default function App() {
  return (
    <Card title="æ ‡é¢˜">
      <Counter />
    </Card>
  )
}
```

**æœ€ç»ˆæ¸²æŸ“ç»“æœ**

```html
<div>
  <h2>æ ‡é¢˜</h2>
  <div>
    <!-- Counter ç»„ä»¶ -->
    <button>ç‚¹å‡»æ¬¡æ•°: 0</button>
  </div>
</div>
```

## Hooks
`Hook` æ˜¯ç‰¹æ®Šçš„å‡½æ•°, åªåœ¨ `React` æ¸²æŸ“æ—¶æœ‰æ•ˆ, èƒ½è®©ä½  `Hook` è¿› `React` çš„ç‰¹æ€§, å¦‚ `state`ã€ç”Ÿå‘½å‘¨æœŸç­‰

`Hook` ä»¥ `use` å¼€å¤´, å¦‚ `useState`, **åªèƒ½åœ¨ç»„ä»¶æˆ–è‡ªå®šä¹‰ `Hook` çš„é¡¶å±‚è°ƒç”¨**, ä¸èƒ½åœ¨å¾ªç¯ã€æ¡ä»¶è¯­å¥ä¸­è°ƒç”¨ (å¯ä»¥ç†è§£ä¸ºåœ¨ç»„ä»¶é¡¶éƒ¨å¯¼å…¥ `æ¨¡å—`)

#### è‡ªå®šä¹‰ Hook
è‡ªå®šä¹‰ `Hook` æ˜¯ä¸€ä¸ªå‡½æ•°, å…¶åç§°ä»¥ `use` å¼€å¤´, å‡½æ•°å†…éƒ¨å¯ä»¥è°ƒç”¨å…¶ä»– `Hook`, ç”¨ä»¥å¤ç”¨ä¸€äº›é€»è¾‘, ä¾‹å¦‚ä¸‹é¢çš„ `useOnlineStatus`; è‡ªå®šä¹‰ `Hook` ä¹Ÿåº”å½“æ˜¯çº¯å‡½æ•°

### useState
{% notel green æœ¬æ®µå¯¼èˆª %}
{% btn æ¸²æŸ“æœºåˆ¶::#æ¸²æŸ“æœºåˆ¶ %} {% btn æ¸²æŸ“å‡½æ•°::#æ¸²æŸ“å‡½æ•° %} {% btn æ›´æ–°å¯¹è±¡åŠ `useImmer` åº“::#æ›´æ–°å¯¹è±¡ %} {% btn æ›´æ–°æ•°ç»„::#æ›´æ–°æ•°ç»„ %} {% btn çŠ¶æ€ç®¡ç†::#çŠ¶æ€ç®¡ç† %} {% btn çŠ¶æ€çš„ä¿ç•™å’Œé‡ç½®::#çŠ¶æ€çš„ä¿ç•™å’Œé‡ç½® %} {% btn `flushSync`::#flushSync %}
{% endnotel %}

`useState` æ˜¯ `React` æä¾›çš„ä¸€ä¸ªå†…ç½® `Hook`, ç”¨äºå®šä¹‰ç»„ä»¶çš„ `state`, è®©ç»„ä»¶èƒ½å¤Ÿä¿å­˜å’Œæ›´æ–°æ•°æ®

```jsx
// å¼•å…¥ useState
import { useState } from 'react'
// å®šä¹‰ç»„ä»¶
function Counter() {
  // å®šä¹‰ state å˜é‡
  const [count, setCount] = useState(0)
  // å®šä¹‰äº‹ä»¶å¤„ç†å‡½æ•°
  const handleClick = () => setCount(count + 1)
  return (
    <div>
      // ä½¿ç”¨ state å’Œ setState
      <button onClick={handleClick}>ç‚¹å‡»æ¬¡æ•°: {count}</button>
    </div>
  )
}
```

```tsx
// ä½¿ç”¨ TypeScript
// åˆå§‹å€¼é any ç±»å‹æ—¶, æ— éœ€æŒ‡å®šæ³›å‹ç±»å‹
const [count, setCount] = useState<number>(0)
```

- `useState` æ¥æ”¶ä¸€ä¸ªå‚æ•°, å³ `state` çš„åˆå§‹å€¼
- `useState` è¿”å›ä¸€ä¸ªæ•°ç»„, ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ `state`, ç¬¬äºŒä¸ªå…ƒç´ æ˜¯æ›´æ–° `state` çš„å‡½æ•°
- `state` åªèƒ½é€šè¿‡ `setState` å‡½æ•°æ›´æ–°, ç›´æ¥ä¿®æ”¹ `state` ä¸ä¼šè§¦å‘é‡æ–°æ¸²æŸ“
- ä¸€ä¸ªç»„ä»¶å¯ä»¥æœ‰å¤šä¸ª `state`; æ¯ä¸ªç»„ä»¶çš„ `state` æ˜¯ç‹¬ç«‹å’Œç§æœ‰çš„, ç”± `React` ç®¡ç†
- **`state` å’Œ `setState` å¯ä»¥ä½œä¸º `props` ä¼ é€’ç»™å­ç»„ä»¶, ä»¥å®ç°æ•°æ®å…±äº«; è¿™ç§è¡Œä¸ºç§°ä¸º `çŠ¶æ€æå‡`**

#### æ¸²æŸ“æœºåˆ¶
ç»„ä»¶æ˜¾ç¤ºåˆ°å±å¹•ä¹‹å‰ï¼Œå…¶å¿…é¡»è¢« `React` æ¸²æŸ“; æœ‰ä¸¤ç§æƒ…å†µä¼šå¯¼è‡´ç»„å»ºçš„æ¸²æŸ“: ç»„ä»¶çš„**åˆæ¬¡æ¸²æŸ“**å’Œ**ç»„ä»¶æˆ–å…¶ç¥–å…ˆçš„çŠ¶æ€ `state` å‘ç”Ÿå˜åŒ–**

```jsx
// åˆæ¬¡æ¸²æŸ“
ReactDOM.createRoot(document.querySelector('#root')).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
) // è¿™æ˜¯ vite åˆ›å»ºé¡¹ç›®æ—¶çš„ main.jsx æ–‡ä»¶

// çŠ¶æ€å‘ç”Ÿå˜åŒ–
import { useState } from 'react'
export default function Form() {
  // å®šä¹‰ state å˜é‡
  const [isSent, setIsSent] = useState(false)
  if (isSent) {
    return <h1>Your message is on its way!</h1>
  }
  return (
    <form onSubmit={e => {
      e.preventDefault()
      setIsSent(true)
    }}>
      // ç‚¹å‡»æŒ‰é’®å, state å‘ç”Ÿå˜åŒ–, ç»„ä»¶é‡æ–°æ¸²æŸ“
      // é¡µé¢æ˜¾ç¤º "Your message is on its way!"
      <button type="submit">Send</button>
    </form>
  )
}
```

- `React.StrictMode` æ˜¯ä¸€ä¸ªç”¨äºæ£€æµ‹ `React` åº”ç”¨ä¸­æ½œåœ¨é—®é¢˜çš„å·¥å…·, ä¼šåœ¨å¼€å‘ç¯å¢ƒä¸‹æ£€æµ‹å‰¯ä½œç”¨
- é‡æ–°æ¸²æŸ“ä¸€ä¸ªç»„ä»¶æ—¶, `React` ä¼šå†æ¬¡è°ƒç”¨ç»„ä»¶å‡½æ•°, ç»„ä»¶å‡½æ•°è¿”å›æ–°çš„ `JSX` å…ƒç´ , `React` ä¼šæ¯”è¾ƒæ–°æ—§ `JSX` å…ƒç´ , ä»…æ›´æ–°éœ€è¦æ›´æ–°çš„éƒ¨åˆ† (è€Œä¸æ˜¯æ•´ä¸ªå…ƒç´ ä¹ƒè‡³æ•´ä¸ª `DOM`)
- äº‹ä»¶å¤„ç†å‡½æ•°æ‰§è¡Œå®Œæ¯•åæ‰ä¼šè§¦å‘é‡æ–°æ¸²æŸ“, å› æ­¤å¯ä»¥åœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­ä¿®æ”¹å¤šä¸ª `state` å˜é‡, åªä¼šè§¦å‘ä¸€æ¬¡é‡æ–°æ¸²æŸ“
- `setState` å‡½æ•°**ä¸ä¼šç«‹å³æ›´æ–° `state`**, åªä¼šæ”¹å˜ä¸‹æ¬¡æ¸²æŸ“æ—¶çš„ `state`, è§ä»¥ä¸‹ç¤ºä¾‹

```jsx
const [number, setNumber] = useState(0)
return (
  <>
    <h1>{number}</h1>
    <button onClick={() => {
      // æ­¤æ—¶ number ä¸º 0
      setNumber(number + 1)
      // æ­¤æ—¶ number ä»ä¸º 0, ä¸‹æ¬¡æ¸²æŸ“æ—¶ number ä¸º 0 + 1
      setNumber(number + 1)
      // æ­¤æ—¶ number ä»ä¸º 0, ä¸‹æ¬¡æ¸²æŸ“æ—¶ number ä¸º 0 + 1
      setNumber(number + 1)
      // æ­¤æ—¶ number ä»ä¸º 0, ä¸‹æ¬¡æ¸²æŸ“æ—¶ number ä¸º 0 + 1
      alert(number) // 0
      setTimer(() => {
        alert(number) // è¿˜æ˜¯ 0!! number ä¾ç…§è°ƒç”¨æ—¶çš„å€¼
      }, 10000)
    }}>+3</button>
  </>
) // ä¸‹æ¬¡æ¸²æŸ“æ—¶, number ä¸º 1
```

> æ€»ä¹‹, **ä¸€ä¸ª `state` å˜é‡çš„å€¼æ°¸è¿œä¸ä¼šåœ¨ä¸€æ¬¡æ¸²æŸ“çš„å†…éƒ¨æ”¹å˜**

#### æ¸²æŸ“å‡½æ•°
å¦‚æœéœ€è¦åœ¨ä¸‹æ¬¡æ¸²æŸ“å‰, å¤šæ¬¡æ›´æ–°åŒä¸€ä¸ª `state`, å¯ä»¥å°†ä¸€ä¸ªå‡½æ•°ä¼ é€’ç»™ `setState`

```jsx
const [number, setNumber] = useState(0)
return (
  <>
    <h1>{number}</h1>
    <button onClick={() => {
      setNumber(number + 1) // ç›¸å½“äº (n => number + 1)
      // å°† number = 1 åŠ å…¥é˜Ÿåˆ—
      setNumber(number + 1)
      // å°† number = 1 åŠ å…¥é˜Ÿåˆ—
      setNumber(n => n + 1)
      // å°† number = number + 1 åŠ å…¥é˜Ÿåˆ—
      setNumber(n => n + 1)
      // å°† number = number + 1 åŠ å…¥é˜Ÿåˆ—
      setNumber(n => n + 1)
      // å°† number = number + 1 åŠ å…¥é˜Ÿåˆ—
    }}>+3</button>
  </>
) // ä¸‹æ¬¡æ¸²æŸ“æ—¶, number ä¸º 4
```

> å½“æ¸²æŸ“å‡½æ•°è¢«ä¼ é€’ç»™ `setState` æ—¶, `React` ä¼šå°†æ­¤å‡½æ•°åŠ å…¥é˜Ÿåˆ—, ä»¥ä¾¿åœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­çš„æ‰€æœ‰å…¶ä»–ä»£ç è¿è¡Œåè¿›è¡Œå¤„ç†; åœ¨ä¸‹ä¸€æ¬¡æ¸²æŸ“æœŸé—´ï¼Œ`React` ä¼šéå†é˜Ÿåˆ—å¹¶ç»™ä½ æ›´æ–°ä¹‹åçš„æœ€ç»ˆ `state`

#### æ›´æ–°å¯¹è±¡
`state` ä¸­å¯ä»¥ä¿å­˜ä»»æ„ç±»å‹çš„ `JavaScript` å€¼ï¼ŒåŒ…æ‹¬å¯¹è±¡; ä½†æ˜¯ï¼Œä½ ä¸åº”è¯¥ç›´æ¥ä¿®æ”¹å­˜æ”¾åœ¨ `React` `state` ä¸­çš„å¯¹è±¡; ç›¸åï¼Œå½“ä½ æƒ³è¦æ›´æ–°ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œä½ éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼ˆæˆ–è€…å°†å…¶æ‹·è´ä¸€ä»½ï¼‰ï¼Œç„¶åå°† `state` æ›´æ–°ä¸ºæ­¤å¯¹è±¡

ç®€è€Œè¨€ä¹‹, åº”æŠŠ `state` è§†ä½œ `Object.freeze` çš„å¯¹è±¡, ä¸è¦ç›´æ¥ä¿®æ”¹ `state` çš„å±æ€§, è€Œæ˜¯åŒæ ·ä½¿ç”¨ `setState` å‡½æ•°ç»™ `state` èµ‹æ–°å€¼

```jsx
const [potion, setPotion] = useState({ x: 0, y: 0 })

// é”™è¯¯ç¤ºä¾‹
onPointerMove={e => {
  potion.x = e.clientX
  potion.y = e.clientY
}}

// æ­£ç¡®ç¤ºä¾‹
onPointerMove={e => {
  setPotion({ 
    x: e.clientX,
    y: e.clientY 
  })
}}
```

##### ä½¿ç”¨å±•å¼€è¿ç®—ç¬¦
```jsx
const [potion, setPotion] = useState({ x: 0, y: 0, z: 0 })

updateX = x => setPotion({ ...potion, x })
```

> æ³¨æ„: å±•å¼€è¿ç®—ç¬¦åªä¼šå¤åˆ¶å¯¹è±¡çš„ç¬¬ä¸€å±‚å±æ€§ (æµ…æ‹·è´)

##### ä½¿ç”¨ Immer åº“
```bash
pnpm add use-immer
```

```jsx
import { useImmer } from 'use-immer'
// ä½¿ç”¨ useImmer æ›¿ä»£ useState

const [potion, setPotion] = useImmer({ x: 0, y: 0, z: 0 })

updateX = x => setPotion(draft => {
  draft.x = x
})
```

#### æ›´æ–°æ•°ç»„
æ›´æ–°æ•°ç»„æ—¶, ä¹Ÿåº”è¯¥åˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„, è€Œä¸æ˜¯ç›´æ¥ä¿®æ”¹åŸæ•°ç»„

| ç›®çš„ | é¿å…ä½¿ç”¨ | æ¨èä½¿ç”¨ |
| :---: | :---: | :---: |
| æ·»åŠ å…ƒç´  | `push`, `unshift` | `concat`, `[...arr, item]` |
| åˆ é™¤å…ƒç´  | `pop`, `shift`, `splice` | `filter`, `slice` |
| æ›¿æ¢å…ƒç´  | `splice`, `arr[i] = item` | `map` |
| æ’åº | `sort`, `reverse` | å…ˆå¤åˆ¶ä¸€ä»½, å†æ’åº |

- å¦‚æœæ•°ç»„ä¸­çš„å…ƒç´ æ˜¯åŸºæœ¬ç±»å‹, å¯ä»¥ç›´æ¥ä½¿ç”¨ `...` è¿ç®—ç¬¦å¤åˆ¶æ•°ç»„, ç„¶åä¿®æ”¹å…¶ä¸­çš„å…ƒç´ 
- å¦‚æœæ•°ç»„ä¸­çš„å…ƒç´ æ˜¯å¯¹è±¡, å¯ä»¥åœ¨ `map` æ–¹æ³•ä¸­ä½¿ç”¨å±•å¼€è¿ç®—ç¬¦å¤åˆ¶å¯¹è±¡, ç„¶åä¿®æ”¹å…¶ä¸­çš„å±æ€§
- **åŒæ ·, å¯ä»¥ä½¿ç”¨ `useImmer` åº“æ¥æ›´æ–°æ•°ç»„**

#### çŠ¶æ€ç®¡ç†
`React` æ§åˆ¶ `UI` çš„æ–¹å¼æ˜¯å£°æ˜å¼çš„; ä¸å¿…ç›´æ¥æ“ä½œ `DOM`, åªéœ€å£°æ˜ `UI` åœ¨ç»™å®šçŠ¶æ€ä¸‹åº”è¯¥æ˜¯ä»€ä¹ˆæ ·å­, `React` ä¼šè‡ªåŠ¨å¤„ç† `UI` çš„æ›´æ–°

ä»¥ `èµ›åšç”»å¸ˆå°å¶å­` ä¸ºä¾‹, å‘½ä»¤å¼ç¼–ç¨‹ä¸º `ç‚¹å‡»ç”ŸæˆæŒ‰é’® -> ç¦ç”¨æŒ‰é’® -> è®¾ç½®æŒ‰é’®æ–‡æœ¬ -> ... -> é‡ç½®æŒ‰é’®æ–‡æœ¬ -> å¯ç”¨æŒ‰é’®`; è€Œå£°æ˜å¼ç¼–ç¨‹ä¸º `ç‚¹å‡»ç”ŸæˆæŒ‰é’® -> ç”ŸæˆæŒ‰é’®å˜ä¸ºåŠ è½½çŠ¶æ€ -> ... -> ç”ŸæˆæŒ‰é’®å˜ä¸ºå¯ç‚¹å‡»çŠ¶æ€`

çŠ¶æ€çš„æ”¹å˜å¯èƒ½æ˜¯å› ä¸ºç”¨æˆ·çš„æ“ä½œ, ä¹Ÿå¯èƒ½æ˜¯å› ä¸ºç½‘ç»œè¯·æ±‚ã€å®šæ—¶å™¨ç­‰å¤–éƒ¨å› ç´ 

##### ä½¿ç”¨ state çš„ä¸€äº›åŸåˆ™
- **åˆå¹¶å…³è”çš„ `state`**: å¦‚æœä½ æ€»æ˜¯åŒæ—¶æ›´æ–°ä¸¤ä¸ªæˆ–æ›´å¤šçš„ `state` å˜é‡ï¼Œè¯·è€ƒè™‘å°†å®ƒä»¬åˆå¹¶ä¸ºä¸€ä¸ªå•ç‹¬çš„ `state` å˜é‡
- **é¿å…äº’ç›¸çŸ›ç›¾çš„ `state`**: å½“ `state` ç»“æ„ä¸­å­˜åœ¨å¤šä¸ªç›¸äº’çŸ›ç›¾æˆ–ä¸ä¸€è‡´çš„ `state` æ—¶ï¼Œä½ å°±å¯èƒ½ä¸ºæ­¤ä¼šç•™ä¸‹éšæ‚£; åº”å°½é‡é¿å…è¿™ç§æƒ…å†µ
- **é¿å…å†—ä½™çš„ `state`**: å¦‚æœä½ èƒ½åœ¨æ¸²æŸ“æœŸé—´ä»ç»„ä»¶çš„ `props` æˆ–å…¶ç°æœ‰çš„ `state` å˜é‡ä¸­è®¡ç®—å‡ºä¸€äº›ä¿¡æ¯ï¼Œåˆ™ä¸åº”å°†è¿™äº›ä¿¡æ¯æ”¾å…¥è¯¥ç»„ä»¶çš„ `state` ä¸­
- **é¿å…é‡å¤çš„ `state`**: å½“åŒä¸€æ•°æ®åœ¨å¤šä¸ª `state` å˜é‡ä¹‹é—´æˆ–åœ¨å¤šä¸ªåµŒå¥—å¯¹è±¡ä¸­é‡å¤æ—¶ï¼Œè¿™ä¼šå¾ˆéš¾ä¿æŒå®ƒä»¬åŒæ­¥; åº”å°½å¯èƒ½å‡å°‘é‡å¤
- **é¿å…æ·±åº¦åµŒå¥—çš„ `state`**: æ·±åº¦åˆ†å±‚çš„ `state` æ›´æ–°èµ·æ¥ä¸æ˜¯å¾ˆæ–¹ä¾¿; å¦‚æœå¯èƒ½çš„è¯ï¼Œæœ€å¥½ä»¥æ‰å¹³åŒ–æ–¹å¼æ„å»º `state`

```jsx
// åˆå¹¶å…³è”çš„ state, é”™è¯¯ç¤ºä¾‹
const [x, setX] = useState(0)
const [y, setY] = useState(0)
const [z, setZ] = useState(0)
// æ­£ç¡®ç¤ºä¾‹
const [state, setState] = useState({ x: 0, y: 0, z: 0 })

// é¿å…äº’ç›¸çŸ›ç›¾çš„ state, é”™è¯¯ç¤ºä¾‹
const [isSent, setIsSent] = useState(false)
const [isError, setIsError] = useState(false)
// æ­£ç¡®ç¤ºä¾‹
const [status, setStatus] = useState('sent')

// é¿å…å†—ä½™çš„ state, é”™è¯¯ç¤ºä¾‹
const [firstName, setFirstName] = useState('')
const [lastName, setLastName] = useState('')
const [fullName, setFullName] = useState('')
// æ­£ç¡®ç¤ºä¾‹
const [firstName, setFirstName] = useState('')
const [lastName, setLastName] = useState('')
const fullName = `${firstName} ${lastName}`

// é¿å…é‡å¤çš„ state, é”™è¯¯ç¤ºä¾‹
const [user, setUser] = useState({ name: 'xiaoyezi', age: 18 })
const [selectedUser, setSelectedUser] = useState({ name: 'xiaoyezi', age: 18 })
// æ­£ç¡®ç¤ºä¾‹
const [user, setUser] = useState({ name: 'xiaoyezi', age: 18 })
const [selectedUserName, setSelectedUserName] = useState('xiaoyezi')

// é¿å…æ·±åº¦åµŒå¥—çš„ state
// å¯ä»¥ä½¿ç”¨ useImmer åº“
```

#### çŠ¶æ€çš„ä¿ç•™å’Œé‡ç½®
- ä¸€ä¸ªç»„ä»¶è¢«å¸è½½å, å…¶ `state` ä¼šè¢«é”€æ¯, é‡æ–°æŒ‚è½½æ—¶ä¼šé‡æ–°åˆå§‹åŒ–
- ä½†åœ¨ `UI` æ ‘ä¸­ç›¸åŒä½ç½®çš„ç›¸åŒç»„ä»¶ (ä½†ä¼ å…¥çš„å±æ€§å¯èƒ½ä¸åŒ, å¦‚åˆ‡æ¢ä¸åŒçš„æ˜¾ç¤ºçŠ¶æ€æˆ–æ ·å¼ç­‰) ä¼šä½¿ `state` ä¿ç•™
- è€Œåœ¨ `UI` æ ‘ä¸­ç›¸åŒä½ç½®çš„ä¸åŒç»„ä»¶ (å¦‚ `div` å’Œ `p`) ä¼šä½¿ `state` é‡æ–°åˆå§‹åŒ– (å› ä¸ºæ­¤æ—¶æ˜¯é”€æ¯åé‡æ–°æŒ‚è½½, è€Œä¸Šé¢æ˜¯æ›´æ–°); è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¸è¦åœ¨ç»„ä»¶å†…éƒ¨å®šä¹‰ç»„ä»¶
- å¦‚æœåœ¨ç›¸åŒä½ç½®é‡ç½® `state`, å¯ä»¥å°†ç»„ä»¶æ¸²æŸ“åœ¨ä¸åŒçš„ä½ç½® (è§ä¸‹é¢çš„ç¤ºä¾‹), æˆ–è€…åœ¨ `key` å±æ€§ä¸­ä¼ å…¥ä¸€ä¸ªéšæœºå€¼
- `key` å±æ€§æ˜¯ `React` ç”¨æ¥è¯†åˆ«ç»„ä»¶çš„å”¯ä¸€æ ‡è¯†, å½“ `key` æ”¹å˜æ—¶, `React` ä¼šé”€æ¯åŸæœ‰ç»„ä»¶, å¹¶é‡æ–°åˆ›å»ºæ–°çš„ç»„ä»¶ `æ³¨æ„: keyåªéœ€åœ¨å…„å¼ŸèŠ‚ç‚¹ä¸­ä¿æŒå”¯ä¸€å³å¯`
- å¦‚æœæƒ³åœ¨ç»„ä»¶é”€æ¯åä¿ç•™ `state`, å¯ä»¥ä½¿ç”¨çŠ¶æ€æå‡, ä¸é”€æ¯è€Œæ˜¯éšè—ç»„ä»¶, å­˜å…¥ `localStorage` ç­‰æ–¹æ³•

```jsx
// æ¸²æŸ“åœ¨åŒä¸€ä¸ªä½ç½®
return (
  <div>
    {isPlayerA ? <Player role="A" /> : <Player role="B" />}
  </div>
)

// æ¸²æŸ“åœ¨ä¸åŒçš„ä½ç½®
return (
  <div>
    {isPlayerA && <Player role="A" />}
    {isPlayerA || <Player role="B" />}
  </div>
)

// ä½¿ç”¨ key å±æ€§
return (
  <div>
    <Player key={isPlayerA ? 'A' : 'B'} role={isPlayerA ? 'A' : 'B'} />
  </div>
)
```

#### flushSync
{% note yellow é‡è¦æç¤º %}
åœ¨å¼‚æ­¥å‡½æ•° (`Promise`)ã€å®šæ—¶å™¨ã€è‡ªå®šä¹‰äº‹ä»¶ä¸­, `setState` ä¼šä½¿ `state` ç«‹å³æ›´æ–°, é¡µé¢ç«‹å³é‡æ–°æ¸²æŸ“; `React18` ä¹‹å, ä¹Ÿå¼•å…¥äº†åœ¨è¿™äº›æƒ…å†µä¸‹çš„ `batchedUpdates` æœºåˆ¶, ä¼šåœ¨å®‰å…¨çš„æƒ…å†µä¸‹å°†å¤šä¸ª `setState` åˆå¹¶ä¸ºä¸€ä¸ªæ›´æ–°

é€šå¸¸ `React` èƒ½å¤Ÿæ­£ç¡®åˆ¤æ–­æ˜¯å¦éœ€è¦åˆå¹¶æ›´æ–° (å¦‚åœ¨ `èµ›åšç”»å¸ˆå°å¶å­` ä¸­, æäº¤è¡¨å•åçš„äº‹ä»¶å¤„ç†å‡½æ•°å†…çš„ `setState` ä¸ä¼šè¢«åˆå¹¶, æ­£å¦‚æˆ‘æœŸæœ›çš„é‚£æ ·); ä½†æ˜¯, å¦‚æœä½ éœ€è¦åœ¨æŸäº›æƒ…å†µä¸‹ç«‹å³æ›´æ–° `state`, å¯ä»¥ä½¿ç”¨ `flushSync` å‡½æ•°
{% endnote %}

```jsx
import { flushSync } from 'react-dom'

// åœ¨å¼‚æ­¥å‡½æ•°ä¸­ç«‹å³æ›´æ–° state
async function fetchData() {
  const data = await fetch('https://api.example.com/data')
  flushSync(() => {
    setData(data)
  })
}
```

> å‚è§[è¿™ç¯‡æ–‡ç« ](https://github.com/reactwg/react-18/discussions/21)

### useReducer
å¯¹äºæ‹¥æœ‰è®¸å¤š `state` æ›´æ–°é€»è¾‘çš„ç»„ä»¶æ¥è¯´ï¼Œè¿‡äºåˆ†æ•£çš„äº‹ä»¶å¤„ç†ç¨‹åºå¯èƒ½ä¼šä»¤äººä¸çŸ¥æ‰€æª; å¯¹äºè¿™ç§æƒ…å†µï¼Œå¯ä»¥å°†ç»„ä»¶çš„æ‰€æœ‰ `state` æ›´æ–°é€»è¾‘æ•´åˆåˆ°ä¸€ä¸ªå¤–éƒ¨å‡½æ•°ä¸­ï¼Œè¿™ä¸ªå‡½æ•°å«ä½œ `reducer`

è¦å°† `state` æ›´æ–°é€»è¾‘æ•´åˆåˆ° `reducer` ä¸­ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤æ¥å®ç°:

1. å°† `setState(value)` å‡½æ•°æ›¿æ¢ä¸º `dispatch(action)` å‡½æ•°
  - `setState` æ˜¯å‘Šè¯‰ `React` è¦åšä»€ä¹ˆ, è€Œ `dispatch` æ˜¯å‘Šè¯‰ `React` ç”¨æˆ·åšäº†ä»€ä¹ˆ (å³ `action`)
  - ä¼ é€’ç»™ `dispatch` çš„å‚æ•°ç§°ä¸º `action` å¯¹è±¡, é€šå¸¸åŒ…å«ä¸€ä¸ª `type` å±æ€§, ç”¨äºæè¿° `action` çš„ç±»å‹ 
2. ç¼–å†™ä¸€ä¸ª `reducer` å‡½æ•°
  - `reducer` å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°: `state` (å½“å‰çŠ¶æ€) å’Œ `action`, å¹¶è¿”å›ä¸€ä¸ªæ–°çš„ `state` (æ–°çŠ¶æ€)
  - `React` ä¼šå°† `state` è®¾ç½®ä¸º `reducer` å‡½æ•°çš„è¿”å›å€¼
  - ç”±äº `reducer` æ¥å— `state` ä½œä¸ºå‚æ•°, æ‰€ä»¥**å¯ä»¥åœ¨ç»„ä»¶å¤–éƒ¨å®šä¹‰ `reducer` å‡½æ•°**
  - æ¨èåœ¨ `reducer` å‡½æ•°ä¸­ä½¿ç”¨ `switch (action.type)` è¯­å¥, ä»¥ä¾¿æ ¹æ® `action.type` æ‰§è¡Œä¸åŒçš„æ“ä½œ
3. ä½¿ç”¨ `useReducer` `Hook`
  - ä¾‹å¦‚ `const [state, dispatch] = useReducer(reducer, initialState)`
  - å¯ä»¥å°† `reducer` å‡½æ•°æ”¾åœ¨ç»„ä»¶å¤–éƒ¨, ç”šè‡³æ˜¯å•ç‹¬çš„æ–‡ä»¶ä¸­, ä»¥ä¾¿åœ¨å¤šä¸ªç»„ä»¶ä¹‹é—´å…±äº«
  - `reducer` å‡½æ•°ä¹Ÿåº”å½“æ˜¯çº¯å‡½æ•°, å³è¾“å…¥ç›¸åŒåˆ™è¾“å‡ºç›¸åŒ, ä¸”ä¸åŒ…å«å¼‚æ­¥è¯·æ±‚æˆ–å‰¯ä½œç”¨

{% note green %}
`use-immer` åº“æä¾›äº†ä¸€ä¸ª `useImmerReducer` å‡½æ•°, ç”¨äºåœ¨ `reducer` å‡½æ•°ä¸­ä½¿ç”¨ `Immer` åº“, æ­¤æ—¶ `reducer` å‡½æ•°æ¥å— `draft, action` ä¸¤ä¸ªå‚æ•°, `draft` ä¸º `state` çš„å¯å˜å‰¯æœ¬, å¯ä»¥ç›´æ¥ä¿®æ”¹ `draft`
{% endnote %}

```jsx
import { useReducer } from 'react'

// å®šä¹‰ reducer å‡½æ•°
function reducer(state, action) {
  switch (action.type) {
    case 'increment':
      return { count: state.count + 1 }
    case 'decrement':
      return { count: state.count - 1 }
    default:
      throw new Error()
  }
}

// ä½¿ç”¨ useReducer
export default function Counter() {
  const [state, dispatch] = useReducer(reducer, { count: 0 })
  return (
    <div>
      <button onClick={() => dispatch({ type: 'decrement' })}>-</button>
      <span>{state.count}</span>
      <button onClick={() => dispatch({ type: 'increment' })}>+</button>
    </div>
  )
}
```

### useContext
{% notel green æœ¬æ®µå¯¼èˆª %}
{% btn æ³¨æ„äº‹é¡¹::#æ³¨æ„äº‹é¡¹ %} {% btn ä¸ `Reducer` æ­é…ä½¿ç”¨::#ä¸-Reducer-æ­é…ä½¿ç”¨ %}
{% endnotel %}

`Context` æä¾›äº†ä¸€ç§åœ¨ç»„ä»¶ä¹‹é—´å…±äº«å€¼çš„æ–¹å¼, è€Œä¸å¿…é€šè¿‡ `props` ä¸€å±‚å±‚ä¼ é€’æ•°æ®; é€šè¿‡ä»¥ä¸‹æ­¥éª¤ä½¿ç”¨ `Context`:

- é¦–å…ˆ, åœ¨ç‹¬ç«‹çš„æ–‡ä»¶å¼•å…¥ `createContext` å‡½æ•°, åˆ›å»ºä¸€ä¸ª `Context` å¯¹è±¡å¹¶å¯¼å‡º; ä¾‹å¦‚ `export const LevelContext = createContext(1)`, å…¶ä¸­ `1` ä¸º `Context` å¯¹è±¡çš„åˆå§‹å€¼
- ç„¶å, åœ¨éœ€è¦å…±äº«æ•°æ®çš„ç»„ä»¶ä¸­, ä½¿ç”¨ `const xxx = useContext(Context)` `Hook` è·å– `Context` å¯¹è±¡
- æœ€å, å¦‚æœéœ€è¦æ›´æ–° `Context` ä¸­çš„æ•°æ®, å¯ä»¥åœ¨çˆ¶å…ƒç´ ä¸­ä½¿ç”¨ `<Context.Provider value={data}>{children}</Context.Provider>` åŒ…è£¹å­å…ƒç´ , å¹¶åœ¨å­å…ƒç´ ä¸­ä½¿ç”¨ `useContext` è·å– `Context` å¯¹è±¡ (æ­¤æ—¶ `Context` å¯¹è±¡çš„å€¼ä¸º `value` å±æ€§çš„å€¼)
- æ³¨æ„: å¦‚æœä¸ä½¿ç”¨ `Context.Provider` æ›´æ–° `Context` ä¸­çš„æ•°æ®, åˆ™æ‰€æœ‰å­å­™ç»„ä»¶ä¸­çš„ `Context` å¯¹è±¡çš„å€¼éƒ½æ˜¯åˆå§‹å€¼
- å¯ä»¥ä½¿ç”¨ `const level = useContext(LevelContext)` å’Œ `<LevelContext.Provider value={level + 1}>{children}</LevelContext.Provider>` è¿™æ ·çš„å†™æ³•å®ç° `Context` é€çº§é€’å¢

```jsx
// LevelContext.js
import { createContext } from 'react'
export const LevelContext = createContext(1)

// App.js
import { Section } from './Section'
export default function App() {
  return (
    <Section> // æ˜¾ç¤ºå½“å‰å±‚çº§: 1
      <Section> // æ˜¾ç¤ºå½“å‰å±‚çº§: 2
        <div>
          <div>
            <Section /> // æ˜¾ç¤ºå½“å‰å±‚çº§: 3
          </div>
        </div>
      </Section>
    </Section>
  )
}

// Section.js
import { useContext } from 'react'
import { LevelContext } from './LevelContext'
export function Section({ children }) {
  const level = useContext(LevelContext)
  return (
    <LevelContext.Provider value={level + 1}>
      <div>å½“å‰å±‚çº§: {level}</div>
      {children}
    </LevelContext.Provider>
  )
}
```

#### æ³¨æ„äº‹é¡¹
{% note yellow %}
åœ¨ `React19` ä¹‹å, æ— éœ€å†ä½¿ç”¨ `Context.Provider`, ç›´æ¥ä½¿ç”¨ `Context` å³å¯

```jsx
// LevelContext.js
import { createContext } from 'react'
export const LevelContext = createContext(1)

// App.js
export default function App() {
  return (
    <>
      <LevelContext value={1}>
        <Section />
      </LevelContext>
    </>
  )
}
```
{% endnote %}

- `Context` å¯¹è±¡çš„ `value` å±æ€§å¯ä»¥æ˜¯ä»»ä½•ç±»å‹çš„å€¼, åŒ…æ‹¬å‡½æ•°, å¯¹è±¡, æ•°ç»„ç­‰
- ä¸è¦æ»¥ç”¨ `Context`, è€Œæ˜¯ä¼˜å…ˆåœ¨å±‚çº§ä¸å¤šæ—¶ä½¿ç”¨ `props` ä¼ é€’æ•°æ®
- `Context` å¸¸ç”¨äºå®šä¹‰å…¨å±€ä¸»é¢˜ã€ç”¨æˆ·ä¿¡æ¯ã€è·¯ç”±ä¿¡æ¯ç­‰
- é€šå¸¸å°† `reducer` å‡½æ•°å’Œ `Context` å¯¹è±¡æ”¾åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­æ­é…ä½¿ç”¨, ä»¥ä¾¿ç®¡ç†å¤æ‚çš„çŠ¶æ€

#### ä¸ Reducer æ­é…ä½¿ç”¨
å°† `useReducer` åˆ›å»ºçš„ `state` å’Œ `dispatch` å‡½æ•°æ”¾åœ¨ `Context` ä¸­, å¯ä»¥åœ¨ä»»ä½•ç»„ä»¶ä¸­ä½¿ç”¨ `useContext` è·å– `state` å’Œ `dispatch` å‡½æ•°, ä»¥å®ç°å…¨å±€çŠ¶æ€ç®¡ç†

```jsx
// CounterContext.js
import { createContext, useReducer } from 'react'
const [count, dispatch] = useReducer(reducer, 0)
function reducer(state, action) {
  switch (action.type) {
    case 'increment':
      return state + 1
    case 'decrement':
      return state - 1
    default:
      throw new Error()
  }
}
const CounterContext = createContext({ count, dispatch })

// App.js
export default function App() {
  return (
    <>
      <Counter />
      <Counter />
    </>    
  )
}

// Counter.js
import { useContext } from 'react'
import { CounterContext } from './CounterContext'
export default function Counter() {
  const { count, dispatch } = useContext(CounterContext)
  return (
    <div>
      <button onClick={() => dispatch({ type: 'decrement' })}>-</button>
      <span>{count}</span>
      <button onClick={() => dispatch({ type: 'increment' })}>+</button>
    </div>
  )
}
```

### useRef
{% notel green æœ¬æ®µå¯¼èˆª %}
{% btn è·å– `DOM` å…ƒç´ ::#ä½¿ç”¨-ref-è·å–-DOM-å…ƒç´  %} {% btn å°† `ref` ä¼ é€’ç»™å­ç»„ä»¶::#å°†-ref-ä¼ é€’ç»™å­ç»„ä»¶ %} {% btn `useImperativeHandle`::#useImperativeHandle %} {% btn `ref` æ¸…ç†å‡½æ•°::#ref-æ¸…ç†å‡½æ•° %}
{% endnotel %}

å½“å¸Œæœ›åœ¨ `React` ç»„ä»¶ä¸­ä¿å­˜ä¸€ä¸ªå¯å˜å€¼, ä½†ä¸å¸Œæœ›å› ä¸ºå€¼çš„æ”¹å˜è€Œè§¦å‘é‡æ–°æ¸²æŸ“æ—¶, å¯ä»¥ä½¿ç”¨ `useRef`

`ref` æ˜¯ä¸€ç§è„±å›´æœºåˆ¶, åº”å½“åªåœ¨éœ€è¦ `è·³å‡ºReact` çš„æƒ…å†µä¸‹ä½¿ç”¨; åº”å½“é¿å…é€šè¿‡ `ref` æ›´æ”¹ç”± `React` ç®¡ç†çš„ `DOM` å…ƒç´ , é™¤éè¯¥å…ƒç´ ä¸ä¼šè¢«æ›´æ–°

```jsx
import { useRef } from 'react'

export default function Counter() {
  // åˆ›å»º ref
  const ref = useRef(0)
  // ä½¿ç”¨ ref
  function handleClick() {
    ref.current += 1
    alert('ä½ ç‚¹å‡»äº† ' + ref.current + ' æ¬¡ï¼')
  }
  // æ¸²æŸ“
  return (
    <button onClick={handleClick}>
      ç‚¹å‡»æˆ‘ï¼
    </button>
  )
}
```

```tsx
// ä½¿ç”¨ TypeScript
const ref = useRef<HTMLDivElement>(null)
```

- `useRef` è¿”å›ä¸€ä¸ªå¯å˜çš„ `ref` å¯¹è±¡, å…¶ `current` å±æ€§è¢«åˆå§‹åŒ–ä¸ºä¼ å…¥çš„å‚æ•° (å¦‚æœæ²¡æœ‰ä¼ å…¥å‚æ•°, åˆ™ä¸º `undefined`)
- `ref.current` å±æ€§å¯ä»¥ä¿å­˜ä»»ä½•å€¼, å¹¶ä¸”ä¸ä¼šè§¦å‘é‡æ–°æ¸²æŸ“, å¯ä»¥ç”¨æ¥ä¿å­˜è®¡æ—¶å™¨ `ID`ã€`DOM` å…ƒç´ å¼•ç”¨ã€ä¸éœ€è¦è¢«ç”¨æ¥è®¡ç®— `JSX` çš„å€¼ç­‰
- **ä¸åº”åœ¨æ¸²æŸ“æ—¶ä¿®æ”¹æˆ–ä½¿ç”¨ `ref.current` çš„å€¼**: ä¸Šé¢çš„ä¾‹å­ä¸­, å¦‚æœä¸æ˜¯ `alert` å¼¹çª—, è€Œæ˜¯ç›´æ¥åœ¨ `DOM` ä¸­æ˜¾ç¤ºç‚¹å‡»æ¬¡æ•°, åˆ™æ¬¡æ•°ä¼šéšç€ç‚¹å‡»æ¬¡æ•°çš„å¢åŠ è€Œå¢åŠ , ä½†æ–‡æœ¬ä¸ä¼šæ›´æ–°
- å¯ä»¥å°† `ref` è§†ä¸ºæ²¡æœ‰ `setState` çš„ `state`

#### ä½¿ç”¨ ref è·å– DOM å…ƒç´ 
å½“å°† `ref` å¯¹è±¡è®¾ç½®ä¸º `JSX` å…ƒç´ çš„ `ref` å±æ€§æ—¶, `ref.current` å±æ€§å°†å¼•ç”¨è¯¥ `DOM` å…ƒç´ ; è€Œä¸”, å½“ `DOM` å…ƒç´ è¢«å¸è½½æ—¶, `ref.current` å±æ€§å°†è¢«è®¾ç½®ä¸º `null`

```jsx
import { useRef } from 'react'

export default function App() {
  // ä¸º input å…ƒç´ åˆ›å»º ref
  const inputRef = useRef(null)
  // ç‚¹å‡»æŒ‰é’®æ—¶èšç„¦ input å…ƒç´ 
  function focusInput() {
    inputRef.current.focus()
  }
  // æ¸²æŸ“
  return (
    <div>
      <input ref={inputRef} />
      <button onClick={focusInput}>Focus</button>
    </div>
  )
}
```

> å¦‚æœéœ€è¦ç»™ä¸å®šé‡çš„ `DOM` å…ƒç´ æ·»åŠ  `ref`, å¯å·²ä¸å°†å…ƒç´ æœ¬èº«ä½œä¸º `ref` çš„å€¼, è€Œæ˜¯å°†ä¸€ä¸ªæ•°ç»„æˆ– `Map` ä½œä¸º `ref` çš„å€¼

#### å°† ref ä¼ é€’ç»™å­ç»„ä»¶
`React` é»˜è®¤ä¸å…è®¸å°† `ref` å±æ€§ä¼ é€’ç»™å­ç»„ä»¶ (å¦‚ `<Cover />`), ä»¥ä½¿ä»£ç æ›´å¥å£®; æƒ³è¦å°†è‡ªå·±çš„ `DOM` èŠ‚ç‚¹æš´éœ²çš„ç»„ä»¶å¿…é¡»ç”¨å¦ä¸€ç§æ–¹å¼æ¥å®šä¹‰: `forwardRef()`

{% note yellow %}
åœ¨ `React19` åŠä¹‹åçš„ç‰ˆæœ¬ä¸­, `ref` å¯ä»¥ç›´æ¥ä½œä¸º `props` ä¼ é€’ç»™å­ç»„ä»¶, ä¸å†éœ€è¦ `forwardRef` å‡½æ•°

```jsx
// çˆ¶ç»„ä»¶
export default function App() {
  const childRef = useRef(null)
  return <Child ref={childRef} />
}

// å­ç»„ä»¶
export default function Child(props) {
  return <input ref={props.ref} />
}
```
{% endnote %}

```jsx
import { forwardRef, useRef } from 'react'

// å­ç»„ä»¶
const Child = forwardRef((props, ref) => {
  return <input ref={ref} />
})

// çˆ¶ç»„ä»¶
export default function App() {
  // åˆ›å»º ref
  const childRef = useRef(null)
  // èšç„¦ Child ç»„ä»¶
  function focusInput() {
    childRef.current.focus()
  }
  // æ¸²æŸ“, å°† ref ä¼ é€’ç»™å­ç»„ä»¶
  return (
    <div>
      <Child ref={childRef} />
      <button onClick={focusInput}>Focus</button>
    </div>
  )
}
```

#### useImperativeHandle
`useImperativeHandle` å¯ä»¥è®©ä½ åœ¨ä½¿ç”¨ `ref` æ—¶åªå°†éœ€è¦æš´éœ²ç»™çˆ¶ç»„ä»¶çš„å®ä¾‹å€¼æš´éœ²å‡ºå»

```jsx
import { forwardRef, useImperativeHandle, useRef } from 'react'

// å­ç»„ä»¶
const Child = forwardRef((props, ref) => {
  // åˆ›å»ºè‡ªå·±çš„ ref
  const inputRef = useRef(null)
  // é€šè¿‡ useImperativeHandle
  // åªå°† inputRef çš„ focus æ–¹æ³•æš´éœ²ç»™çˆ¶ç»„ä»¶ ref
  useImperativeHandle(ref, () => ({
    focus: () => {
      inputRef.current.focus()
    }
  }))
  // ä½¿ç”¨è‡ªå·±çš„ ref ç»‘å®š input å…ƒç´ 
  return <input ref={inputRef} />
})

// çˆ¶ç»„ä»¶åŒä¸Š
```

#### ref æ¸…ç†å‡½æ•°
`React19` ä¹‹å, ç»™å…ƒç´ æ·»åŠ  `ref` å±æ€§æ—¶, å¯ä»¥è¿”å›ä¸€ä¸ªæ¸…ç†å‡½æ•°, ç”¨äºåœ¨å…ƒç´ è¢«å¸è½½æ—¶æ‰§è¡Œæ¸…ç†æ“ä½œ

```jsx
<div ref={divRef => {
  // å…ƒç´ è¢«æŒ‚è½½æ—¶æ‰§è¡Œ
  console.log('æŒ‚è½½')
  return () => {
    // å…ƒç´ è¢«å¸è½½æ—¶æ‰§è¡Œ
    console.log('å¸è½½')
  }
}} />
// åœ¨å¼€å‘ç¯å¢ƒä¸­, å°†æ‰“å°: æŒ‚è½½, å¸è½½, æŒ‚è½½
```

### useEffect
{% notel green æœ¬æ®µå¯¼èˆª %}
{% btn ç§»é™¤ä¸å¿…è¦çš„ `Effect`::#ç§»é™¤ä¸å¿…è¦çš„-Effect %} {% btn `Effect` çš„ç”Ÿå‘½å‘¨æœŸ::#Effect-çš„ç”Ÿå‘½å‘¨æœŸ %} {% btn `useEffectEvent`::#useEffectEvent %}
{% endnotel %}

`Effect` å…è®¸ç»„ä»¶è¿æ¥åˆ°**å¤–éƒ¨ç³»ç»Ÿ**å¹¶ä¸ä¹‹åŒæ­¥; è¿™åŒ…æ‹¬å¤„ç†ç½‘ç»œã€æµè§ˆå™¨ã€`DOM`ã€åŠ¨ç”»ã€ä½¿ç”¨ä¸åŒ `UI` åº“ (å¦‚ `Vue`) ç¼–å†™çš„å°éƒ¨ä»¶ä»¥åŠå…¶ä»–é `React` ä»£ç 

- `useEffect` ç”¨äºç”±æ¸²æŸ“æœ¬èº«, è€Œéç”¨æˆ·ç‚¹å‡»ç­‰äº‹ä»¶, è§¦å‘çš„å‰¯ä½œç”¨çš„æ“ä½œ; å®ƒæ¥æ”¶ä¸¤ä¸ªå‚æ•°: `(setup[, dependencies[]])`
- `setup` å‡½æ•°åœ¨å¿…è¦æ—¶åº”è¿”å›ä¸€ä¸ª `æ¸…ç†å‡½æ•°`, ç”¨äºæ¸…ç†å‰¯ä½œç”¨; åœ¨ç»„ä»¶æ¸²æŸ“å, `React` ä¼šè°ƒç”¨ `setup` å‡½æ•° (å¦‚ `è¿æ¥`), å¹¶åœ¨ç»„ä»¶å¸è½½æˆ–æ›´æ–°æ—¶è°ƒç”¨ `æ¸…ç†å‡½æ•°` (å¦‚ `æ–­å¼€è¿æ¥`)
- æ¸…ç†å‡½æ•°ä¸€èˆ¬æ˜¯æ–­å¼€è¿æ¥ã€ç§»é™¤äº‹ä»¶ç›‘å¬å™¨ã€é‡ç½®åŠ¨ç”»; ä¸ç®¡æŒ‡ä¸æŒ‡å®šæ¸…ç†å‡½æ•°, **åœ¨å¼€å‘ç¯å¢ƒä¸­** `useEffect` éƒ½ä¼šè¿è¡Œä¸¤æ¬¡ (è¿™ä¸ªé—®é¢˜æ˜¯**æ­£å¸¸çš„**, æ˜¯ä¸ºäº†æ£€æµ‹å‰¯ä½œç”¨æ˜¯å¦æ­£ç¡®æ¸…ç†)
- `dependencies` æ•°ç»„ç”¨äºæŒ‡å®š `setup` å‡½æ•°çš„ä¾èµ–é¡¹, **åªæœ‰å½“ä¾èµ–é¡¹å‘ç”Ÿå˜åŒ–æ—¶**, `setup` å‡½æ•°æ‰ä¼šé‡æ–°æ‰§è¡Œ
- ä¾èµ–é¡¹å¯ä»¥æ˜¯ `state` å˜é‡ã€`props`ã€`context` ç­‰ä»»æ„æ¸²æŸ“æ—¶å¯èƒ½æ”¹å˜çš„å€¼; **ä¸ä¼ å…¥** `dependencies` æ•°ç»„, åˆ™ `setup` å‡½æ•°åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶éƒ½ä¼šæ‰§è¡Œ; **ä¼ å…¥ `[]`**, åˆ™ `setup` å‡½æ•°åªä¼šåœ¨ç»„ä»¶æŒ‚è½½æ—¶æ‰§è¡Œ (è€Œ `æ¸…ç†å‡½æ•°` åªä¼šåœ¨ç»„ä»¶å¸è½½æ—¶æ‰§è¡Œ)
- **è‡ªå·±**çš„ `ref`ã€`setState` å‡½æ•°ç­‰**ç¨³å®šçš„æ ‡è¯†ç¬¦**ä¸éœ€è¦æ”¾å…¥ `dependencies` æ•°ç»„ä¸­ (å› ä¸ºå®ƒä»¬åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶éƒ½æ˜¯ç›¸åŒçš„, æ°¸è¿œä¸ä¼šä½¿ `setup` å‡½æ•°æ‰§è¡Œ)

```jsx
// æ ¹æ®å±å¹•å®½åº¦éšæ—¶æ›´æ–° swiper çš„ slidesPerView
const [slidesPerView, setSlidesPerView] = useState(3)
// ä½¿ç”¨ useEffect
useEffect(() => {
  // äº‹ä»¶å¤„ç†å‡½æ•°
  function updateSlidesPerView() {
    if (window.innerWidth < 1000) {
      setSlidesPerView(1)
    } else if (window.innerWidth < 1500) {
      setSlidesPerView(2)
    } else {
      setSlidesPerView(3)
    }
  }
  // åˆå§‹åŒ–
  updateSlidesPerView()
  // ç›‘å¬ resize äº‹ä»¶
  window.addEventListener('resize', updateSlidesPerView)
  // æ¸…ç†
  return () => {
    window.removeEventListener('resize', updateSlidesPerView)
  }
}, [])
```

#### ç§»é™¤ä¸å¿…è¦çš„ Effect
- `useEffect` é€šå¸¸åªåº”ç”¨äºä¸**å¤–éƒ¨ç³»ç»Ÿ**äº¤äº’, ä¾‹å¦‚è¿™æ®µä»£ç ä¼šé™·å…¥æ­»å¾ªç¯: `useEffect(() => setCount(count + 1))`
- å¦‚æœä½¿ç”¨äº† `Next.js` ç­‰æ¡†æ¶, æ¨èä½¿ç”¨è¿™äº›æ¡†æ¶æä¾›çš„æ•°æ®è·å–æœºåˆ¶å–ä»£ `useEffect`
- æŸäº›é€»è¾‘å¦‚æœåªéœ€è¦åœ¨åº”ç”¨å¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡, å¯ä»¥å°†ä»–ä»¬æ”¾äºç»„ä»¶å¤–éƒ¨, è€Œä¸æ˜¯ä½¿ç”¨ `useEffect` (**é¡¶å±‚ä»£ç ä¼šåœ¨ç»„ä»¶è¢«å¯¼å…¥æ—¶æ‰§è¡Œä¸€æ¬¡**, ä½†ä¹Ÿä¸è¦æ»¥ç”¨è¿™ç§æ–¹å¼)
- ä¸€äº›**æ˜‚è´µ**çš„è®¡ç®—, å¯ä»¥ä½¿ç”¨ `useMemo` `Hook` ç¼“å­˜è®¡ç®—ç»“æœ, è€Œä¸æ˜¯åœ¨ `useEffect` ä¸­è®¡ç®—
- å¦‚æœæƒ³è¦åœ¨ `props` å˜åŒ–æ—¶é‡ç½® `state`, ä¸è¦ç”¨ `useEffect(() => setState(''), [props])` è¿™æ ·çš„å†™æ³•, è€Œæ˜¯ä½¿ç”¨ç»„ä»¶çš„ `key` å±æ€§
- **èƒ½æ”¾è¿›äº‹ä»¶å¤„ç†å‡½æ•°çš„é€»è¾‘, å°½é‡ä¸è¦æ”¾åœ¨ `useEffect` ä¸­** (çµæ´»ä½¿ç”¨çŠ¶æ€æå‡ã€`Context` ç­‰)
- å¦‚æœéœ€è¦è®¢é˜…å¤–éƒ¨ `state` å˜åŒ–, å¯ä»¥ä½¿ç”¨ `useSyncExternalStore` `Hook`, è€Œä¸æ˜¯åœ¨ `useEffect` ä¸­è®¢é˜…
- åœ¨ä½¿ç”¨ `useEffect` å¼‚æ­¥è·å–æ•°æ®æ—¶, å¯èƒ½å‡ºç°æ•°æ®ç«äº‰é—®é¢˜, é™¤äº†ä½¿ç”¨ `Next.js` ç­‰æ¡†æ¶æä¾›çš„æ•°æ®è·å–æœºåˆ¶, è¿˜å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è‡ªå®šä¹‰ `Hook`

> æœªæ¥ç‰ˆæœ¬çš„ `React` ä¼šæä¾›æ›´å¥½çš„æ•°æ®è·å–æœºåˆ¶, ä»¥è§£å†³æ•°æ®ç«äº‰é—®é¢˜

```jsx
function SearchResults({ query }) {
  const [page, setPage] = useState(1)
  const params = new URLSearchParams({ query, page })
  const results = useData(`/api/search?${params}`)

  function handleNextPageClick() {
    setPage(page + 1)
  }
  // ...
}

function useData(url) {
  const [data, setData] = useState(null)
  useEffect(() => {
    let ignore = false
    fetch(url)
      .then(response => response.json())
      .then(json => {
        if (!ignore) {
          setData(json)
        }
      })
    // è¿”å›ä¸€ä¸ªæ¸…ç†å‡½æ•°
    // å¿½ç•¥è¾ƒæ—©è¿”å›çš„å¼‚æ­¥è¯·æ±‚
    // åªæœ‰æœ€æ–°çš„è¯·æ±‚æ‰ä¼šæ›´æ–°æ•°æ®
    return () => {
      ignore = true
    }
  }, [url])
  return data
}
```

#### Effect çš„ç”Ÿå‘½å‘¨æœŸ
- ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸæœ‰ä¸‰ä¸ªé˜¶æ®µ: æŒ‚è½½ã€æ›´æ–°ã€å¸è½½
- è€Œ `useEffect` çš„ç”Ÿå‘½å‘¨æœŸæœ‰ä¸¤ä¸ªé˜¶æ®µ: å¼€å§‹åŒæ­¥ (ä¸»ä½“ä»£ç ) å’Œåœæ­¢åŒæ­¥ (æ¸…ç†ä»£ç )
- `Effect` çš„ç”Ÿå‘½å‘¨æœŸä¸ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸä¸å®Œå…¨å¯¹åº”, åŒæ­¥å’Œåœæ­¢åŒæ­¥éƒ½å¯èƒ½åœ¨ç»„ä»¶çš„ä¸€ä¸ªæ¸²æŸ“å‘¨æœŸå†…å¤šæ¬¡æ‰§è¡Œ (å¦‚æœ `dependencies` å‘ç”Ÿå˜åŒ–, ä¸”è¯¥å˜åŒ–ä¸ä¼šå¼•èµ·ç»„ä»¶é‡æ–°æ¸²æŸ“)
- **ä¸**é€šè¿‡ `useSyncExternalStore` è·å–çš„å…¨å±€å˜é‡ã€`ref.current` ä¸èƒ½æ”¾å…¥ `dependencies` æ•°ç»„ä¸­, å› ä¸ºå®ƒä»¬æ‰“ç ´äº†**ç»„ä»¶åº”æ˜¯çº¯å‡½æ•°**çš„åŸåˆ™; é…ç½®äº† `eslint` æ—¶, ä¼šæœ‰è­¦å‘Š
- `dependencies` å¿…é¡»åŒ…å«**æ‰€æœ‰** `useEffect` ä¸­ä½¿ç”¨çš„**å“åº”å¼å€¼**, `eslint` ä¼šæ£€æµ‹å¹¶ç»™å‡ºè­¦å‘Š, æ­¤æ—¶åº”æ·»åŠ æ‰€æœ‰ä¾èµ–é¡¹æˆ–**å‘ `eslint` è¯æ˜å…¶ä¸éœ€è¦è¿™ä¸ªä¾èµ–é¡¹** (å³è¯¥å˜é‡æ˜¯éå“åº”å¼çš„), å¦‚åœ¨ç»„ä»¶å¤–éƒ¨å®šä¹‰è¯¥å˜é‡æˆ–å‡½æ•°
- ä¸€ä¸ª `useEffect` åº”å½“åªåšä¸€ä»¶äº‹, å¦‚æœéœ€è¦åšå¤šä»¶äº‹, åº”å½“æ‹†åˆ†æˆå¤šä¸ª `useEffect`, ä»è€Œä½¿ä¾èµ–é¡¹æ›´åŠ æ¸…æ™°å’Œé¿å…äº¤å‰å¹²æ‰°

#### useEffectEvent
{% note yellow %}
`useEffectEvent` æ˜¯ä¸€ä¸ªå°šæœªåœ¨ç¨³å®šç‰ˆå‘å¸ƒçš„å®éªŒæ€§ `Hook`
{% endnote %}

å¦‚æœåœ¨ `useEffect` ä¸­åŒæ—¶åŒ…å«ä¸€äº›å“åº”å¼äº‹ä»¶å’Œéå“åº”å¼äº‹ä»¶, é‚£å¯èƒ½å¯¼è‡´å‘ç”Ÿéå“åº”å¼äº‹ä»¶æ—¶, ç”±äº `dependencies` çš„å˜åŒ–, è€Œä¸å¿…è¦åœ°è§¦å‘ä¸€äº›è¡Œä¸º

`useEffectEvent` å¯ä»¥å°†äº‹ä»¶å¤„ç†å‡½æ•°æå–åˆ°ä¸€ä¸ªå•ç‹¬çš„ `Hook` ä¸­, ä»¥ä¾¿åœ¨ `useEffect` ä¸­ä½¿ç”¨

- å¾… `useEffectEvent` å®Œå…¨ç¨³å®šå, æ¨è**æ°¸è¿œä¸è¦ç¦ç”¨ `eslint` çš„æç¤º**
- æ°¸è¿œåªåº”åœ¨ `useEffect` ä¸­ä½¿ç”¨ `useEffectEvent`, æ°¸è¿œä¸è¦æŠŠ `useEffectEvent` ä¼ é€’ç»™å…¶ä»– `Hook` æˆ–ç»„ä»¶
- é€šå¸¸åœ¨ `useEffect` æ—è¾¹å®šä¹‰ `useEffectEvent`
- ä¸ºä»€ä¹ˆè¦ç”¨ `useEffectEvent`: å®ƒæ˜¯**éå“åº”å¼çš„**, åªæœ‰åœ¨äº‹ä»¶å‘ç”Ÿæ—¶æ‰ä¼šæ‰§è¡Œ, ä¾‹å¦‚, å¦‚æœä»çˆ¶ç»„ä»¶ä¼ é€’çš„ `props` ä¸­è·å–äº†ä¸€ä¸ªå¤„ç†å‡½æ•°, ä½†ä¸æƒ³æŠŠå®ƒæ”¾å…¥ `dependencies` æ•°ç»„ä¸­, å¯ä»¥ä½¿ç”¨ `useEffectEvent` (æ­¤æ—¶è¿™ä¸ªä¼ å…¥çš„å¤„ç†å‡½æ•°å¯ä»¥å˜åŒ–, ä½†ä¸ä¼šè§¦å‘ `useEffect` é‡æ–°æ‰§è¡Œ)

```jsx
// é”™è¯¯ç¤ºä¾‹
function ChatRoom({ roomId, theme }) {
  useEffect(() => {
    const connection = createConnection(serverUrl, roomId)
    connection.on('connected', () => {
      showNotification('Connected!', theme)
    })
    connection.connect()
    return () => connection.disconnect()
  }, [roomId, theme]) // âŒ åˆ‡æ¢ä¸»é¢˜æ—¶ä¼šé‡æ–°è¿æ¥

  return <h1>Welcome to the {roomId} room!</h1>
}

// æ­£ç¡®ç¤ºä¾‹
function ChatRoom({ roomId, theme }) {
  // å£°æ˜ onConnected äº‹ä»¶
  const onConnected = useEffectEvent(() => {
    showNotification('Connected!', theme)
  })
  // ä½¿ç”¨ useEffectEvent
  useEffect(() => {
    const connection = createConnection(serverUrl, roomId)
    connection.on('connected', () => {
      onConnected()
    })
    connection.connect()
    return () => connection.disconnect()
  }, [roomId]) // âœ… åªæœ‰ roomId å˜åŒ–æ—¶ä¼šé‡æ–°è¿æ¥
  
  return <h1>Welcome to the {roomId} room!</h1>
}
```

```jsx
// é”™è¯¯ç¤ºä¾‹
function Page({ url }) {
  const { items } = useContext(ShoppingCartContext);
  const numberOfItems = items.length;

  useEffect(() => {
    logVisit(url, numberOfItems);
  }, [url]); // ğŸ”´ React Hook useEffect ç¼ºå°‘ä¾èµ–é¡¹: â€˜numberOfItemsâ€™
  // ...
}

// æ­£ç¡®ç¤ºä¾‹
function Page({ url }) {
  const { items } = useContext(ShoppingCartContext);
  const numberOfItems = items.length;

  const onVisit = useEffectEvent(visitedUrl => {
    logVisit(visitedUrl, numberOfItems);
  });

  useEffect(() => {
    onVisit(url);
  }, [url]); // âœ… å£°æ˜æ‰€æœ‰ä¾èµ–é¡¹
  // ...
}
```

### useMemo
`useMemo(calculateValue, dependencies)` ç”¨äºç¼“å­˜è®¡ç®—ç»“æœ, åªæœ‰å½“ `dependencies` æ•°ç»„ä¸­çš„å€¼å‘ç”Ÿå˜åŒ–æ—¶, æ‰ä¼šé‡æ–°è®¡ç®—

- `calculateValue` åº”å½“æ˜¯æ²¡æœ‰ä»»ä½•å‚æ•°å’Œå‰¯ä½œç”¨çš„çº¯å‡½æ•°, `React` ä¼šå°†å…¶è¿”å›å€¼ç¼“å­˜èµ·æ¥, å¹¶åœ¨ `dependencies` æ•°ç»„ä¸­çš„å€¼å‘ç”Ÿå˜åŒ–æ—¶é‡æ–°è®¡ç®—
- `dependencies` æ•°ç»„å¯ä»¥æ˜¯ `state` å˜é‡ã€`props`ã€`context` ç­‰
- ç±»ä¼¼äº `useEffect`, åœ¨å¼€å‘ç¯å¢ƒä¸­, `useMemo` ä¹Ÿä¼šè¿è¡Œä¸¤æ¬¡, ä»è€Œå¸®åŠ©å¼€å‘è€…æ£€æµ‹æ½œåœ¨çš„é”™è¯¯
- é™¤éæœ‰ç‰¹å®šåŸå› , `React` **ä¸ä¼šä¸¢å¼ƒç¼“å­˜çš„å€¼**
- ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶, `useMemo` ä¼šè®¡ç®—å¹¶ç¼“å­˜å€¼, ç„¶åå°†å…¶è¿”å›; ä¹‹åçš„æ¸²æŸ“, `useMemo` ä¼šæ¯”è¾ƒ `dependencies` æ•°ç»„ä¸­çš„å€¼æ˜¯å¦å‘ç”Ÿå˜åŒ–, å¦‚æœæ²¡æœ‰å˜åŒ–, åˆ™ç›´æ¥è¿”å›ç¼“å­˜çš„å€¼
- å¯ä»¥ç”¨ `console.time('xxxA'); xxxxxxx; console.timeEnd('xxxA')` æ¥æµ‹è¯•ä¸€ä¸ªæ“ä½œçš„è€—æ—¶, ä»è€Œå†³å®šæ˜¯å¦ä½¿ç”¨ `useMemo`

```jsx
import { useMemo, useState } from 'react'

export default function App() {
  const [number, setNumber] = useState(1000000)
  const sum = useMemo(() => {
    let result = 0
    for (let i = 1; i <= number; i++) {
      result += i
    }
    return result
  }, [number])
  return (
    <>
      <input value={number} onChange={e => setNumber(e.target.value)} />
      <div>1 + 2 + ... + {number} = {sum}</div>
    </>
  )
}
```

### useSyncExternalStore
`useSyncExternalStore(subscribe, getSnapshot[, getServerSnapshot])` ç”¨äºè®¢é˜…å¤–éƒ¨ `state` å˜åŒ–, å¹¶åœ¨ç»„ä»¶å¸è½½æ—¶å–æ¶ˆè®¢é˜…

- `store`: ä¸€ä¸ªå¤–éƒ¨çš„å¯ä»¥æ”¹å˜çš„ `state`
- `subscribe`ï¼šä¸€ä¸ªå‡½æ•°ï¼Œæ¥æ”¶ä¸€ä¸ªå•ç‹¬çš„ `callback` å‚æ•°å¹¶æŠŠå®ƒè®¢é˜…åˆ° `store` ä¸Š; å½“ `store` å‘ç”Ÿæ”¹å˜ï¼Œå®ƒåº”å½“è°ƒç”¨è¢«æä¾›çš„ `callback`; è¿™ä¼šå¯¼è‡´ç»„ä»¶é‡æ–°æ¸²æŸ“; `subscribe` å‡½æ•°ä¼šè¿”å›æ¸…é™¤è®¢é˜…çš„å‡½æ•°
- `getSnapshot`ï¼šä¸€ä¸ªå‡½æ•°ï¼Œè¿”å›ç»„ä»¶éœ€è¦çš„ `store` ä¸­çš„æ•°æ®å¿«ç…§; åœ¨ `store` ä¸å˜çš„æƒ…å†µä¸‹ï¼Œé‡å¤è°ƒç”¨ `getSnapshot` å¿…é¡»è¿”å›åŒä¸€ä¸ªå€¼; å¦‚æœ `store` æ”¹å˜ï¼Œå¹¶ä¸”è¿”å›å€¼ä¹Ÿä¸åŒäº†ï¼ˆç”¨ `Object.is` æ¯”è¾ƒï¼‰ï¼Œ`React` å°±ä¼šé‡æ–°æ¸²æŸ“ç»„ä»¶
- `getServerSnapshot`ï¼šå¯é€‰, ä¸€ä¸ªå‡½æ•°ï¼Œè¿”å› `store` ä¸­æ•°æ®çš„åˆå§‹å¿«ç…§; å®ƒåªä¼šåœ¨**æœåŠ¡ç«¯æ¸²æŸ“**æ—¶ï¼Œä»¥åŠåœ¨å®¢æˆ·ç«¯è¿›è¡ŒæœåŠ¡ç«¯æ¸²æŸ“å†…å®¹çš„ `hydration` æ—¶è¢«ç”¨åˆ°; å¿«ç…§åœ¨æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯ä¹‹é—´å¿…é¡»ç›¸åŒï¼Œå®ƒé€šå¸¸æ˜¯ä»æœåŠ¡ç«¯åºåˆ—åŒ–å¹¶ä¼ åˆ°å®¢æˆ·ç«¯çš„; å¦‚æœä½ å¿½ç•¥æ­¤å‚æ•°ï¼Œåœ¨æœåŠ¡ç«¯æ¸²æŸ“è¿™ä¸ªç»„ä»¶ä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯

```jsx
// è®¢é˜… navigator.onLine çš„å˜åŒ–
// è®¾è®¡ä¸€ä¸ªè‡ªå®šä¹‰ Hook
import { useSyncExternalStore } from 'react'

export function useOnlineStatus() {
  const isOnline = useSyncExternalStore(subscribe, getSnapshot)
  return isOnline
}  

function subscribe(callback) {
  window.addEventListener('online', callback)
  window.addEventListener('offline', callback)
  return () => {
    window.removeEventListener('online', callback)
    window.removeEventListener('offline', callback)
  }
}

function getSnapshot() {
  return navigator.onLine
}
```

```jsx
// ä½¿ç”¨è‡ªå®šä¹‰ Hook
import { useOnlineStatus } from './useOnlineStatus'

export default function App() {
  const isOnline = useOnlineStatus()
  return (
    <div>
      <p>{isOnline ? 'Online' : 'Offline'}</p>
    </div>
  )
}
```

### useActionState
`useActionState(action, initialState, permalink?)` æ˜¯ `React19` æ–°å¢çš„ `Hook`, ç”¨äºæ›¿ä»£ `useFormState`

```tsx
import { useActionState } from 'react'

// action ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ state
async function plus(previousState) {
  return previousState + 1
}

export default function App() {
  const [count, plusAction] = useActionState(plus, 0)
  return (
    <div>
      {/* æœ€åˆæ˜¯ä¼ å…¥çš„åˆå§‹çŠ¶æ€ (0), éšåæ˜¯ action çš„è¿”å›å€¼ */}
      <p>{count}</p>
      {/* è¿”å›çš„æ–°å‡½æ•°å¯ä»¥ç”¨ä½œè¡¨å•çš„ action æˆ–æŒ‰é’®çš„ formAction */}
      <button formAction={plusAction}>+1</button>
    </div>
  )
```

### useFormStatus
`useFormStatus()` æ˜¯ `React19` æ–°å¢çš„ `Hook`, ç”¨äºè¡¨ç¤ºè¡¨å•çŠ¶æ€

```tsx
import { useFormStatus } from 'react'

// æ³¨æ„: useFormStatus å¿…é¡»åœ¨ form çš„å­ç»„ä»¶ä¸­è°ƒç”¨
// ä¸”åªä¼šè¿½è¸ªçˆ¶ form å…ƒç´ çš„çŠ¶æ€
function SubmitBtn() {
  const status = useFormStatus()
  return <button disabled={status.pending}>æäº¤</button>
}

export default function App() {
  return (
    <form action={action}>
      <Submit />
    </form>
  )
}
```

![](/images/note/react-formstatus.png)

### useOptimistic
`useOptimistic()` æ˜¯ `React19` æ–°å¢çš„ `Hook`, ç”¨äºå®ç°ä¹è§‚æ›´æ–°

```tsx
// è¿”å›çš„ optimisticState æ˜¯åŸ state çš„ä¸€ä¸ªå‰¯æœ¬
// ä½†æ˜¯å®ƒåœ¨å¼‚æ­¥æ“ä½œæ—¶å¯ä»¥ä¸ state ä¸åŒæ­¥ (é€šè¿‡ addOptimistic å‡½æ•°)
// å¼‚æ­¥æ“ä½œç»“æŸå, ä¸ä¼šå½±å“ state çš„å€¼
const [optimisticState, addOptimistic] = useOptimistic(
  state, // åˆå§‹ state
  (state, optimisticValue) => {
    // optimisticValue æ˜¯ addOptimistic å‡½æ•°çš„å‚æ•°
    // è¿”å›åœ¨å¼‚æ­¥æ“ä½œæ—¶çš„ optimisticState
  }
)
```

## ğŸš§ use API
`use` æ˜¯ `React19` æ–°å¢çš„ `API`, ç”¨äºåœ¨åŒæ­¥ç»„ä»¶ä¸­è¯»å–å¼‚æ­¥ç»“æœ

## Head
{% notel green æœ¬æ®µå¯¼èˆª %}
{% btn Preload::#Preload %} {% btn Link::#Link %} {% btn Meta::#Meta %} {% btn Title::#Title %}
{% endnotel %}

`React19` æä¾›äº†ä¸€äº›åˆ—æ— éœ€ä½¿ç”¨ `useEffect` å°±èƒ½å‘ `head` æ ‡ç­¾æ·»åŠ  `meta`ã€`title`ã€`link` ç­‰æ ‡ç­¾çš„ `API`

#### Preload
`React19` æä¾›äº†ä¸€ç³»åˆ— `preload` æ–¹æ³•, ç”¨äºåœ¨ç»„ä»¶åŠ è½½æ—¶é¢„åŠ è½½èµ„æº, ä»¥æé«˜æ€§èƒ½

```jsx
import { ... } from 'react-dom'

export default function Component() {
  // é¢„åŠ è½½è„šæœ¬
  preinit('https://example.com/script.js', { as: 'script' })
  // é¢„åŠ è½½å­—ä½“
  preload('https://example.com/font.woff', { as: 'font' })
  // é¢„åŠ è½½æ ·å¼è¡¨
  preload('https://example.com/style.css', { as: 'style' })
  // é¢„æŸ¥è¯¢ DNS
  prefetchDNS('https://example.com')
  // é¢„è¿æ¥
  preconnect('https://example.com')
  
  return (
    <div>
      ...
    </div>
  )
}
```

```html
<!-- æ¸²æŸ“ç»“æœ -->
<html>
  <head>
    <script async src="https://example.com/script.js"></script>
    <link rel="preload" as="font" href="https://example.com/font.woff" />
    <link rel="preload" as="style" href="https://example.com/style.css" />
    <link rel="prefetch-dns" href="https://example.com" />
    <link rel="preconnect" href="https://example.com" />
  </head>
  <body>
    <div>
      ...
    </div>
  </body>
</html>
```

#### Link
`React19` å¯ä»¥åœ¨ç»„ä»¶ä¸­å¼•å…¥æ‰€éœ€æ ·å¼è¡¨, å¹¶å¯é€šè¿‡ `precedence` å±æ€§è®¾ç½®æ ·å¼è¡¨çš„ä¼˜å…ˆçº§

```jsx
function App() {
  return (
    <div>
      <link rel="stylesheet" href="foo" precedence="high" />
      <link rel="stylesheet" href="bar" precedence="default" />
    </div>
  )
}
```

#### Meta
`React19` å¯ä»¥åœ¨ç»„ä»¶ä¸­å¼•å…¥æ‰€éœ€ `meta` æ ‡ç­¾, ä¼šè‡ªåŠ¨æ›¿æ¢ `head` ä¸­çš„ `meta` æ ‡ç­¾

```jsx
function Component() {
  return (
    <div>
      <meta name="author" content="XiaoYeZi" />
      <meta name="keywords" content="React, JavaScript" />
    </div>
  )
}
```

#### Title
`React19` å¯ä»¥åœ¨ç»„ä»¶ä¸­å¼•å…¥æ‰€éœ€ `title` æ ‡ç­¾, ä¼šè‡ªåŠ¨æ›¿æ¢ `head` ä¸­çš„ `title` æ ‡ç­¾

```jsx
function Component() {
  return (
    <div>
      <title>React19</title>
    </div>
  )
}
```

## ReactCompiler
`ReactCompiler` æ˜¯ä¸€ä¸ªç”¨äºä¼˜åŒ– `React` åº”ç”¨æ€§èƒ½çš„å·¥å…·, å®ƒä¼šè‡ªåŠ¨ä½¿ç”¨ `useMemo`, `useCallback` ç­‰ `Hook` æ¥ä¼˜åŒ–ç»„ä»¶

```bash
# æ£€æŸ¥é¡¹ç›®çš„å¥åº·åº¦
bunx react-compiler-healthcheck@latest
# å®‰è£… eslint æ’ä»¶
bun add -D eslint-plugin-react-compiler
# é…ç½® eslint
{
  plugins: ['eslint-plugin-react-compiler'],
  rules: {
    'react-compiler/react-compiler': 'error',
  },
}
# å®‰è£… babel æ’ä»¶
bun add -D babel-plugin-react-compiler
# é…ç½® vite
{
  plugins: [
    react({
      babel: {
        plugins: ['babel-plugin-react-compiler', {}],
      },
    })
  ]
}
```

- åœ¨æµè§ˆå™¨ `DevTools` ä¸­å®‰è£… `React` æ’ä»¶å, è¢«ä¼˜åŒ–çš„ç»„ä»¶æ—è¾¹ä¼šæœ‰ä¸€ä¸ª `â­ Memo` æ ‡å¿—
- å¦‚æœæœ‰äº›ç»„ä»¶å‡ºç°é—®é¢˜, å¯ä»¥åœ¨å‡½æ•°ç»„ä»¶çš„ç¬¬ä¸€è¡Œæ·»åŠ  `'use no memo'` æ¥ç¦ç”¨ä¼˜åŒ–

# &#x2B50;Zustand
`zustand` æ˜¯ä¸€ä¸ªå°å·§çš„ `React` çŠ¶æ€ç®¡ç†åº“, ç”¨äºç®¡ç†å…¨å±€çŠ¶æ€

```tsx
// useZustandStore.ts
import { create } from 'zustand'

interface State {
  count: number
  increment: () => void
  decrement: () => void
}

// æ³¨æ„æ³›å‹åé¢çš„ â€œ()â€
export const useZustandStore = create<State>()(set => ({
  count: 0,
  increment: () => set(state => ({ count: state.count + 1 })),
  decrement: () => set(state => ({ count: state.count - 1 })),
}))
```

```tsx
// App.tsx
import { useZustandStore } from './useZustandStore'

export default function App() {
  // æ‰¹é‡å¯¼å…¥
  const { increment, decrement } = useZustandStore()
  // å¯¼å…¥å•ä¸ª
  const count = useZustandStore(state => state.count)
  // ä½¿ç”¨
  return (
    <div>
      <p>{count}</p>
      <button onClick={increment}>+1</button>
      <button onClick={decrement}>-1</button>
    </div>
  )
}
```

# &#x2B50;Next.js
`Next.js` æ˜¯ä¸€ä¸ªåŸºäº `React` çš„å…¨æ ˆæ¡†æ¶, ç”± `Vercel` å¼€å‘å’Œç»´æŠ¤, ä½¿ç”¨ `bun create next-app` å¯ä»¥å¿«é€Ÿåˆ›å»ºä¸€ä¸ª `Next.js` é¡¹ç›®

`Next.js` åŸºäºæ–‡ä»¶ç³»ç»Ÿè¿›è¡Œè·¯ç”±, `app` ç›®å½•ä¸‹çš„æ–‡ä»¶å¤¹, å¦‚æœæœ‰ `page.js/ts/jsx/tsx` æˆ– `route.js/ts/jsx/tsx` æ–‡ä»¶, åˆ™ä¼šè¢«æ˜ å°„ä¸ºä¸€ä¸ªè·¯ç”±

```bash
# åˆ›å»ºé¡¹ç›®
bun create next-app
# å®‰è£…ä¾èµ–
bun i
# è®¾ç½® ESlint
bun run lint
# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
bun dev
```

{% notel green æœ¬æ®µå¯¼èˆª %}
{% btn æœåŠ¡ç«¯ç»„ä»¶::#æœåŠ¡ç«¯ç»„ä»¶ %} {% btn æ•°æ®ç¼“å­˜::#æ•°æ®ç¼“å­˜ %} {% btn Server Action::#Server-Action %}
{% endnotel %}

#### æœåŠ¡ç«¯ç»„ä»¶
`Next.js` é»˜è®¤è¿›è¡ŒæœåŠ¡ç«¯æ¸²æŸ“ `SSR`, æ­¤æ—¶ç»„ä»¶å¿…é¡»æ˜¯æœåŠ¡ç«¯ç»„ä»¶ `Server Components`, ä»¥ä¾¿åœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶ä½¿ç”¨; å®ƒæœ‰ä»¥ä¸‹ç‰¹ç‚¹:

- æ²¡æœ‰çŠ¶æ€å’Œç”Ÿå‘½å‘¨æœŸï¼Œä¹Ÿå°±**ä¸èƒ½**ä½¿ç”¨ `useState()`ã€`useReducer()`ã€`useEffect()`ã€`useLayoutEffect()`
- **ä¸èƒ½**ä½¿ç”¨æµè§ˆå™¨ç›¸å…³çš„ APIï¼Œå¦‚ `window`ã€`document`ã€`navigator`
- **ä¸èƒ½**ä½¿ç”¨åŸºäºçŠ¶æ€å’Œç”Ÿå‘½å‘¨æœŸçš„è‡ªå®šä¹‰ `hook`ï¼Œä»¥åŠæµè§ˆå™¨ç›¸å…³çš„å·¥å…·åº“
- **å¯ä»¥**ä½¿ç”¨æœåŠ¡ç«¯æ•°æ®æºï¼Œå¦‚æ–‡ä»¶ç³»ç»Ÿã€æ•°æ®åº“ã€å†…éƒ¨å¾®æœåŠ¡
- å¯ä»¥æ¸²æŸ“å…¶ä»–æœåŠ¡ç«¯ç»„ä»¶ã€å®¢æˆ·ç«¯ç»„ä»¶ä»¥åŠåŸç”Ÿ `DOM` å…ƒç´ 
- æœåŠ¡ç«¯ç»„ä»¶**å¯ä»¥è¿”å› `Promise`**
- è¦ä½¿ç”¨å®¢æˆ·ç«¯ç»„ä»¶ï¼Œå¿…é¡»åœ¨ç»„ä»¶æˆ–å…¶ç¥–å…ˆç»„ä»¶çš„ç¬¬ä¸€è¡Œæ·»åŠ  `'use client'`
- åœ¨æœåŠ¡ç«¯ç»„ä»¶ä¸­, å¯ä»¥ä½¿ç”¨ `params`ã€`searchParams` `Prop` æ¥è·å–è·¯ç”±å‚æ•°

## è·¯ç”±
{% notel green æœ¬æ®µå¯¼èˆª %}
{% btn è·¯ç”±æ–‡ä»¶::#è·¯ç”±æ–‡ä»¶ %} {% btn åˆ†ç»„è·¯ç”±::#åˆ†ç»„è·¯ç”± %} {% btn æ’é™¤è·¯ç”±::#æ’é™¤è·¯ç”± %} {% btn åŠ¨æ€è·¯ç”±::#åŠ¨æ€è·¯ç”± %} {% btn å¹³è¡Œè·¯ç”±::#å¹³è¡Œè·¯ç”± %} {% btn æ‹¦æˆªè·¯ç”±::#æ‹¦æˆªè·¯ç”± %}
{% endnotel %}

#### è·¯ç”±æ–‡ä»¶
![](/images/note/react-route.png)

- `public` ç›®å½•ä¸‹çš„æ–‡ä»¶ä¼šè¢«æ˜ å°„ä¸ºé™æ€èµ„æº, å¯ä»¥é€šè¿‡ `/xxx` è®¿é—®
- `layout.x` åº”é»˜è®¤å¯¼å‡ºä¸€ä¸ªä»¥ `children` ä¸º `props` çš„ç»„ä»¶, ç”¨äºåŒ…è£¹å­å­™ç»„ä»¶
- `template.x` ç±»ä¼¼äº `layout.x`, ä½†æ˜¯ä¼šä¸ºæ¯ä¸ªé¡µé¢ç”Ÿæˆæ–°çš„ `DOM` å…ƒç´ 
- é€šè¿‡åœ¨ `page.x` æˆ– `layout.x` ä¸­ `export const metadata: MetaData` æ¥è®¾ç½®é¡µé¢å…ƒæ•°æ®
- `loading.x` ç”¨äºè®¾ç½®åŠ è½½ä¸­çš„é¡µé¢, ä½äº `layout.x` ä¹‹å†…, å®é™…ä¸Šæ˜¯è¢«æ¸²æŸ“ä¸º `Suspense` ç»„ä»¶çš„ `fallback` å±æ€§
- `error.x` å¿…é¡»æ˜¯å®¢æˆ·ç«¯ç»„ä»¶, å…·æœ‰ `error: Error` å’Œ `reset: () => void` ä¸¤ä¸ª `Prop`, ç”¨äºå¤„ç†é”™è¯¯é¡µé¢; `reset` å‡½æ•°ç”¨äºé‡æ–°æ¸²æŸ“é”™è¯¯çš„ç»„ä»¶
- `error.x` ä½äº `layout.x` ä¹‹å†…, å¦‚æœéœ€è¦å¤„ç† `layout.x` æˆ– `template.x` çš„é”™è¯¯, éœ€è¦ä½¿ç”¨ `global-error.x`
- åœ¨ `page.x` (`Server Components`) å’Œ `route.x` ä¸­, åªæœ‰**è¿”å›å€¼**å¯¹å®¢æˆ·ç«¯å¯è§

#### åˆ†ç»„è·¯ç”±
`(folder)` æ–‡ä»¶å¤¹ç”¨äº `Route Groups`, è¿™ä¸ªæ–‡ä»¶å¤¹ä¸ä¼šè¢«æ˜ å°„ä¸ºè·¯ç”±, å…¶å†…éƒ¨çš„æ–‡ä»¶å¤¹ä¼šæ˜ å°„ä¸º `.../xxx` è€Œä¸æ˜¯ `.../folder/xxx` (ç”¨äºæ•´ç†é¡¹ç›®æ–‡ä»¶å¤¹)

`(folder)` æ–‡ä»¶å¤¹å†…å¯ä»¥æœ‰ `layout.x`, ä¸ºç»„å†…æ‰€æœ‰é¡µé¢è®¾ç½®å¸ƒå±€; ä¾‹å¦‚, å¦‚æœç§»é™¤ `app/layout.x`, åˆ™å¯ä»¥åœ¨ `app/(folder1)/layout.x` å’Œ `app/(folder2)/layout.x` ä¸­åˆ†åˆ«è®¾ç½®æ ¹å¸ƒå±€

#### æ’é™¤è·¯ç”±
`_folder` æ–‡ä»¶å¤¹åŠå…¶å†…éƒ¨çš„æ–‡ä»¶å¤¹å’Œæ–‡ä»¶ä¼šè¢«æ’é™¤åœ¨è·¯ç”±ä¹‹å¤–, ç”¨äºå­˜æ”¾ä¸€äº›ä¸éœ€è¦è¢«è·¯ç”±çš„æ–‡ä»¶

å¤„ç†ä¹‹å¤–, ä¹Ÿå¯ä»¥æŠŠä¸éœ€è¦è·¯ç”±çš„æ–‡ä»¶ç›´æ¥æ”¾åœ¨ `app` ç›®å½•å¤–, ä¾‹å¦‚ `src` ç›®å½•; å¦‚æœè¿™ç§æ–¹æ³•å¯¼è‡´è·¯å¾„è¾ƒä¸ºå¤æ‚, `Next.js` æ”¯æŒ `tsconfig.json` ä¸­çš„ `paths` é…ç½®æ¥ä½œä¸ºå¯¼å…¥çš„åˆ«å

```tsx
// tsconfig.json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  }
}

// ä½¿ç”¨åˆ«å
import { ... } from '@/components'
```

#### åŠ¨æ€è·¯ç”±
`[folder]` æ–‡ä»¶å¤¹ç”¨äºåŠ¨æ€è·¯ç”±, çœŸæ˜¯è·¯å¾„å¯ä»¥é€šè¿‡ `layout.x`ã€`page.x`ã€`route.x` ä¸­çš„ `params` `Prop` è·å–

ä¾‹å¦‚, `app/blog/[id]/page.x` å¯ä»¥é€šè¿‡ `params.id` è·å– `id` å‚æ•°

æ­¤å¤–, `[folderName]` æ–‡ä»¶å¤¹å†…çš„ `page.x` è¿˜å¯ä»¥å¯¼å‡ºä¸€ä¸ª `generateStaticParams` å‡½æ•°, è¿”å› `{ folderName: string }[]`, è®© `Next.js` åœ¨æ„å»ºæ—¶å°±ä¸ºè¿™äº›è·¯å¾„ç”Ÿæˆé™æ€é¡µé¢

##### æ·±å±‚åŠ¨æ€è·¯ç”±
`[...folder]` æ–‡ä»¶å¤¹ç”¨äºæ·±å±‚åŠ¨æ€è·¯ç”±, çœŸå®è·¯å¾„å¯ä»¥é€šè¿‡ `layout.x`ã€`page.x`ã€`route.x` ä¸­çš„ `params` `Prop` è·å–, å…¶ä¸­ `params.folder` æ˜¯ä¸€ä¸ªæ•°ç»„

ä¾‹å¦‚, å¯¹äº `app/blog/[...id]/page.x` çš„ `params.id` åœ¨è®¿é—® `/blog/1` æ—¶æ˜¯ `['1']`, åœ¨è®¿é—® `/blog/1/2` æ—¶æ˜¯ `['1', '2']`

##### å¯é€‰åŠ¨æ€è·¯ç”±
`[[folder]]` æ–‡ä»¶å¤¹ç”¨äºå¯é€‰åŠ¨æ€è·¯ç”±, ç›¸æ¯”äº `[...folder]`, `[[folder]]` å¯ä»¥ä¸ä¼ å…¥å‚æ•°

ä¾‹å¦‚, å¯¹äº `app/blog/[[id]]/page.x` çš„ `params.id` åœ¨è®¿é—® `/blog` æ—¶æ˜¯ `undefined`, åœ¨è®¿é—® `/blog/1` æ—¶æ˜¯ `['1']`

##### åµŒå¥—ä½¿ç”¨
![](/images/note/react-dynamic.png)

#### å¹³è¡Œè·¯ç”±
`@folder` æ–‡ä»¶å¤¹ç”¨äºå¹³è¡Œè·¯ç”±, å†…éƒ¨çš„ `page.x` å°†ä½œä¸ºä¸Šå±‚ `layout.x` çš„ `props.folder` ä¼ å…¥, ç”¨äºå¹¶è¡Œæ¸²æŸ“å¤šä¸ªé¡µé¢ (æˆä¸º"æ’æ§½" `slot`)

![](/images/note/react-parallel-routes.webp)

`@folder` ä¸å½±å“ `URL` åœ°å€, ä¾‹å¦‚ `app/@folder/views/page.x` çš„è·¯å¾„æ˜¯ `/views`

å¦‚æœåœ¨æŸä¸ªæ’æ§½å‘ç”Ÿäº†å¯¼èˆªè¡Œä¸º, åˆ™ä¼šåœ¨è¯¥æ’æ§½ä¸­é‡æ–°æ¸²æŸ“æ–°çš„é¡µé¢, è€Œä¸ä¼šå½±å“å…¶ä»–æ’æ§½; **ä½†æ˜¯**, å¦‚æœæ­¤æ—¶é¡µé¢åˆ·æ–°, ç”±äºå…¶ä»–æ’æ§½æ— æ³•åˆ¤æ–­å½“å‰çš„ `URL` æ‰€å¯¹åº”çš„é¡µé¢, ä¼šå‘ˆç° `@folder` ä¸‹çš„ `default.x` é¡µé¢ (å¦‚æœä¸å­˜åœ¨, åˆ™ä¼šå‘ˆç° `404` é¡µé¢)

ä¾‹å¦‚, å¯¹äº `@folder1/views/page.x` å’Œ `@folder2/page.x`, å¦‚æœå½“å‰ `URL` æ˜¯ `/`, è€Œåç‚¹å‡» `@folder1` ä¸‹çš„æŸä¸ªé“¾æ¥è·³è½¬åˆ° `/views`, åˆ™ `@folder2` ä¸‹çš„é¡µé¢ä¸ä¼šå‘ç”Ÿå˜åŒ–; ä½†æ˜¯, å¦‚æœæ­¤æ—¶åˆ·æ–°é¡µé¢, åˆ™ä¼šå‘ˆç° `@folder2` ä¸‹çš„ `default.x` é¡µé¢ (å› ä¸º `@folder2/views/page.x` ä¸å­˜åœ¨)

> `@folder` å†…ä¹Ÿæ”¯æŒ `layout.x`ã€`loading.x`ã€`error.x` ç­‰æ–‡ä»¶

##### useSelectedLayoutSegment
`useSelectedLayoutSegment` æ˜¯ä¸€ä¸ªç”¨äºè·å–ç‰¹å®šæ’æ§½æ­¤æ—¶çš„å®é™…è·¯å¾„çš„ `Hook`

```tsx
// app/layout.tsx

import { useSelectedLayoutSegment } from 'next/navigation'

export default function Layout({ auth }) {
  const selectedSegment = useSelectedLayoutSegment('auth')
  // å½“ç”¨æˆ·å¯¼èˆªåˆ° app/@auth/login æ—¶, selectedSegment ä¸º 'login'
  // å½“ç”¨æˆ·å¯¼èˆªåˆ° app/@auth/register æ—¶, selectedSegment ä¸º 'register'
  // ...
}
```

#### æ‹¦æˆªè·¯ç”±
`(..)folder` ç­‰æ–‡ä»¶å¤¹ç”¨äºæ‹¦æˆªè·¯ç”±, è¯¦è§[å®˜æ–¹æ–‡æ¡£](https://nextjs.org/docs/app/building-your-application/routing/intercepting-routes)

## å¯¼èˆª
### \<Link\> ç»„ä»¶
```tsx
import Link from 'next/link'

export default function Nav() {
  return (
    <nav>
      <Link href="/">Home</Link>
      <Link href="/about">About</Link>
    </nav>
  )
}
```

> å¯¹äº `Link`ã€`router.push`ã€`router.replace` ç­‰å¯¼èˆªæ–¹æ³•, å¯ä»¥è®¾ç½® `scroll` ä¸º `false` æ¥ç¦ç”¨æ»šåŠ¨åˆ°ä¸Šæ¬¡ä½ç½®

### usePathname
å®¢æˆ·ç«¯ç»„ä»¶ä¸­, å¯ä»¥ä½¿ç”¨ `usePathname` æ¥è·å–å½“å‰é¡µé¢çš„è·¯å¾„ (å…·æœ‰å“åº”æ€§)

```tsx
'use client'

import { usePathname } from 'next/navigation'
import Link from 'next/link'

export default function Nav() {
  const pathname = usePathname()
  return (
    <nav>
      <Link href="/" className={pathname === '/' ? 'active' : ''}>Home</Link>
      <Link href="/about" className={pathname === '/about' ? 'active' : ''}>About</Link>
    </nav>
  )
}
```

### useSearchParams
å®¢æˆ·ç«¯ç»„ä»¶ä¸­, å¯ä»¥ä½¿ç”¨ `useSearchParams` æ¥è·å–å½“å‰é¡µé¢çš„æŸ¥è¯¢å‚æ•° (å…·æœ‰å“åº”æ€§)

```tsx
'use client'

import { useSearchParams } from 'next/navigation'

export default function Search() {
  const searchParams = useSearchParams()
  return (
    <form>
      <input type="search" value={searchParams.get('q') || ''} />
      <button type="submit">Search</button>
    </form>
  )
}
```

### useRouter
å®¢æˆ·ç«¯ç»„ä»¶ä¸­, å¯ä»¥ä½¿ç”¨ `useRouter` æ¥æ”¹å˜è·¯ç”±

| æ–¹æ³• | è¯´æ˜ |
| :---: | :---: |
| `router.push(href: string[, options: { scroll?: boolean }])` | è·³è½¬åˆ°æŒ‡å®šè·¯å¾„ |
| `router.replace(href: string[, options: { scroll?: boolean }])` | æ›¿æ¢å½“å‰è·¯å¾„ (ä¸ä¼šåœ¨å†å²è®°å½•ä¸­ç•™ä¸‹è®°å½•) |
| `router.back()` | è¿”å›ä¸Šä¸€é¡µ |
| `router.forward()` | å‰è¿›åˆ°ä¸‹ä¸€é¡µ |
| `router.refresh()` | åˆ·æ–°å½“å‰é¡µé¢ |
| `router.prefetch(href: string)` | é¢„åŠ è½½æŒ‡å®šè·¯å¾„çš„é¡µé¢ |

```tsx
'use client'

import { useRouter } from 'next/navigation'

export default function Nav() {
  const router = useRouter()
  return (
    <nav>
      <button onClick={() => router.push('/')}>Home</button>
      <button onClick={() => router.push('/about')}>About</button>
    </nav>
  )
}
```

### redirect å‡½æ•°
æœåŠ¡ç«¯ç»„ä»¶ä¸­, å¯ä»¥ä½¿ç”¨ `redirect` å‡½æ•°æ¥é‡å®šå‘åˆ°æŒ‡å®šè·¯å¾„

```ts
import { redirect } from 'next/navigation'

export default function Redirect() {
  redirect('/about')
}
```

> `redirect` å‡½æ•°æ˜¯ `307` æˆ– `303` é‡å®šå‘, å¦‚æœè¦ä½¿ç”¨ `308` é‡å®šå‘, å¯ä»¥ä½¿ç”¨ `permanentRedirect` å‡½æ•°

## API
åœ¨ `route.x` ä¸­, å¯ä»¥å®šä¹‰ `Route Handlers` æ¥å¤„ç†è¯·æ±‚

`Next.js` æ”¯æŒ `GET`ã€`POST`ã€`PUT`ã€`DELETE`ã€`PATCH`ã€`OPTIONS`ã€`HEAD` è¯·æ±‚æ–¹æ³•

```ts
// app/api/route.ts

// GET è¯·æ±‚
export async function GET(request: Request): Promise<Response> { }
```

#### ç›¸å…³å†…å®¹
ä» `next/headers` ä¸­å¯¼å…¥ `headers` å‡½æ•°, ç”¨äº**è¯»å–**è¯·æ±‚å¤´

```ts
import { headers } from 'next/headers'
import { redirect } from 'next/navigation'

// è‡ªå®šä¹‰è¿è¡Œç¯å¢ƒ (é»˜è®¤ä¸º nodejs)
export const runtime = 'edge'
 
export async function GET(request: Request) {
  const header = headers() // è¯·æ±‚å¤´, åªè¯»
  redirect('/about') // é‡å®šå‘
}

// å¯ä»¥ä½¿ç”¨ NextRequestã€NextResponse æ¥æ›¿ä»£ Requestã€Response
import { NextRequest, NextResponse } from 'next/server'
export async function POST(request: NextRequest): Promise<NextResponse> { }
```

### NextRequest
| æ–¹æ³• | è¯´æ˜ |
| :---: | :---: |
| `req.cookies` | `cookie` ç›¸å…³æ–¹æ³•, è¯¦è§[å®˜æ–¹æ–‡æ¡£](https://nextjs.org/docs/app/api-reference/functions/next-request) |
| `req.nextUrl.pathname` | è·å–è¯·æ±‚çš„è·¯å¾„ |
| `req.nextUrl.searchParams` | è·å–è¯·æ±‚çš„æŸ¥è¯¢å‚æ•° |
| `req.nextUrl.basePath` | `Next.js` çš„åŸºç¡€è·¯å¾„ |
| `req.nextUrl.buildId` | `Next.js` çš„æ„å»º ID |
| `req.ip` | è·å–è¯·æ±‚çš„ IP åœ°å€<br>å¦‚æœä¸åœ¨ `Vercel` éƒ¨ç½², å¯èƒ½éœ€è¦æ‰‹åŠ¨è®¾ç½® `X-Forwarded-For` è¯·æ±‚å¤´ |
| `req.geo` | è·å–è¯·æ±‚çš„åœ°ç†ä½ç½®ä¿¡æ¯, åŒæ ·åŸºäº `Vercel` çš„æœåŠ¡<br>`{ city, country, region, latitute, longitude }` |

### NextResponse
| æ–¹æ³• | è¯´æ˜ |
| :---: | :---: |
| `NextResponse.next()` | å¸¸ç”¨äºä¸­é—´ä»¶, è¯¦è§[å®˜æ–¹æ–‡æ¡£](https://nextjs.org/docs/app/api-reference/functions/next-response) |
| `res.cookies` | `cookie` ç›¸å…³æ–¹æ³•, è¯¦è§[å®˜æ–¹æ–‡æ¡£](https://nextjs.org/docs/app/api-reference/functions/next-response) |
| `NextResponse.json({})` | è¿”å› `JSON` å“åº” |
| `NextResponse.redirect(new URL('/xxx', request.url))` | è¿”å›é‡å®šå‘å“åº” |
| `NextResponse.rewrite(new URL('/xxx', request.url))` | è¿”å›é‡å†™å“åº” |

### ğŸš§ ä¸­é—´ä»¶
`Next.js` æ”¯æŒä¸­é—´ä»¶, ç”¨äºå¤„ç†è¯·æ±‚å‰çš„é€»è¾‘, ä¾‹å¦‚é‡å®šå‘ã€é‰´æƒã€CORSã€ç¼–è¾‘è¯·æ±‚å¤´ã€å¤„ç†å›½é™…åŒ–ç­‰; è¦å®šä¹‰ä¸­é—´ä»¶, å¯ä»¥åˆ›å»º `app/middleware.ts` æ–‡ä»¶

ä¸­é—´ä»¶ç›®å‰åªæ”¯æŒ `edge` è¿è¡Œç¯å¢ƒ, è¯¦è§[å®˜æ–¹æ–‡æ¡£](https://nextjs.org/docs/app/building-your-application/routing/middleware)

## SSR
### æ•°æ®ç¼“å­˜
`Next.js` ä¼šåœ¨æœåŠ¡ç«¯è¿›è¡Œ `fetch` æ—¶ç¼“å­˜æ•°æ®, é™¤éè¯¥è¯·æ±‚ä½äº `Server Action` æˆ– `Route Handler` çš„ `POST` æ–¹æ³•ä¸­

```ts
// force-cache æ˜¯é»˜è®¤å€¼
fetch('https://api.example.com/data', { cache: 'force-cache' })
// ä¹Ÿå¯ä»¥ä½¿ç”¨ no-cache
fetch('https://api.example.com/data', { cache: 'no-store' })
// å¯ä»¥åŸºäºæ—¶é—´é‡æ–°éªŒè¯æ•°æ® (å•ä½: ç§’)
fetch('https://api.example.com/data', { next: { revalidate: 60 } })
// ä¹Ÿå¯ä»¥åœ¨ layout.x page.x ä¸­æ‰¹é‡è®¾ç½®
export const revalidate = 60
// ä¹Ÿå¯ä»¥åŸºäºæ¡ä»¶é‡æ–°éªŒè¯æ•°æ®
fetch('https://api.example.com/data', { next: { tags: ['tag1', 'tag2'] } })
// è°ƒç”¨ revalidateTag æ¥é‡æ–°éªŒè¯æ•°æ®
import { revalidateTag } from 'next/cache'
export default async function action() {
  revalidateTag('collection')
}
// é‡æ–°éªŒè¯æŸä¸ªè·¯å¾„
import { revalidatePath } from 'next/cache'
export default async function action() {
  revalidatePath('/path')
}
```

### Server Action
`Server Action` æ˜¯è¿è¡ŒäºæœåŠ¡ç«¯çš„ä¸€éƒ¨å‡½æ•°, ä½†å¯ä»¥åœ¨æœåŠ¡ç«¯ç»„ä»¶å’Œå®¢æˆ·ç«¯ç»„ä»¶ä¸­è°ƒç”¨; åœ¨æœåŠ¡ç«¯ç»„ä»¶ä¸­, `Server Action` æ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°, ç¬¬ä¸€è¡Œåº”å£°æ˜ `'use server'`, åœ¨å®¢æˆ·ç«¯ç»„ä»¶ä¸­, `Server Action` å¿…é¡»ç‹¬ç«‹æˆä¸€ä¸ªæ–‡ä»¶, ç¬¬ä¸€è¡Œåº”å£°æ˜ `'use server'`, å¹¶å¯¼å‡ºæ•°ä¸ªå¼‚æ­¥å‡½æ•°

`Server Action` å¯ä»¥ç›´æ¥è°ƒç”¨ã€ç”¨ä½œ `Form` çš„ `action`ã€ä»¥ `Prop` ä¼ é€’ã€ä¸ `useActionState`ã€`useOptimistic`ã€`useFormStatus` ç­‰ `Hook` é…åˆä½¿ç”¨

åœ¨ `Next.js` ä¸­, `Server Action` è¿”å›çš„é”™è¯¯**ä¸ä¼š**åŸæ ·è¿”å›ç»™å®¢æˆ·ç«¯, ä»¥é¿å…æ³„éœ²æ•æ„Ÿä¿¡æ¯

|![](/images/note/react-sa1.png)|![](/images/note/react-sa2.png)|
|:---:|:---:|

### ä¼˜åŒ–
`Next.js` æä¾›äº†æ•°ä¸ªç”¨äºä¼˜åŒ–çš„ç»„ä»¶

#### \<Image\> ç»„ä»¶
```tsx
import Image from 'next/image'

export default function App() {
  return (
    <Image 
      src='/image.jpg' // å›¾ç‰‡è·¯å¾„
      alt='image' // å›¾ç‰‡æè¿°
      width={500} // å›¾ç‰‡å®½åº¦ (ä¼šè‡ªåŠ¨è®¾ç½®)
      height={500} // å›¾ç‰‡é«˜åº¦ (ä¼šè‡ªåŠ¨è®¾ç½®)
      blurDataURL='data:image/png;base64,...' // æ¨¡ç³Šå›¾ç‰‡ (ä¼šè‡ªåŠ¨è®¾ç½®)
    />
  )
}
```

ä¸ºäº†å®‰å…¨èµ·è§, æ‰€æœ‰è·¨åŸŸå›¾ç‰‡éƒ½é»˜è®¤è¢«é™æ­¢, éœ€è¦æ‰‹åŠ¨å…è®¸:

```ts
// next.config.js
module.exports = {
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 's3.amazonaws.com',
        port: '',
        pathname: '/my-bucket/**',
      },
    ],
  },
}
```

#### å­—ä½“
åœ¨ `layout.x` ä¸­, å¯ä»¥å¯¼å…¥ `next/font/google` ä¸­çš„å­—ä½“

```tsx
import { Inter } from 'next/font/google'
 
// If loading a variable font, you don't need to specify the font weight
const inter = Inter({
  subsets: ['latin'],
  display: 'swap',
})
 
export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en" className={inter.className}>
      <body>{children}</body>
    </html>
  )
}
```

> è¿˜å¯ä»¥æŠŠå­—ä½“å˜æˆ `TailwindCSS` çš„ç±»å, è¯¦è§[å®˜æ–¹æ–‡æ¡£](https://nextjs.org/docs/app/building-your-application/optimizing/fonts)

### ğŸš§ èº«ä»½éªŒè¯

### \<Suspense\> ç»„ä»¶
åœ¨æœåŠ¡ç«¯ç»„ä»¶ä¸­, å¯ä»¥ä½¿ç”¨ `Suspense` ç»„ä»¶æ¥æŒ‡å®šåŠ è½½ä¸­çš„é¡µé¢; `loading.x` å®è´¨ä¸Šæ˜¯ `Suspense` ç»„ä»¶çš„ `fallback` å±æ€§

```tsx
export default async function VideoComponent() {
  const src = await getVideoSrc()
 
  return <iframe src={src} frameborder="0" allowfullscreen />
}
```

```tsx
import { Suspense } from 'react'
import VideoComponent from '../ui/VideoComponent.jsx'
 
export default function Page() {
  return (
    <section>
      <Suspense fallback={<p>Loading video...</p>}>
        <VideoComponent />
      </Suspense>
      {/* Other content of the page */}
    </section>
  )
}
```

# &#x2B50;Solid
`Solid` æ˜¯ä¸€ä¸ª[æ›´é«˜æ€§èƒ½](https://krausest.github.io/js-framework-benchmark/current.html)çš„ `React` æ›¿ä»£å“, äºŒè€…çš„è®¾è®¡ç†å¿µå’Œè¯­æ³•éå¸¸ç›¸ä¼¼

`Solid` ç»„ä»¶æ˜¯**å½¼æ­¤å®Œå…¨ç‹¬ç«‹çš„**, å¹¶ä¸”**ç»„ä»¶å‡½æ•°åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡**, 

```bash
# ä½¿ç”¨ Vite åˆ›å»º Solid é¡¹ç›®
pnpm create vite
# é€‰æ‹© Solid æ¨¡æ¿
# ä½ ä¼šå‘ç°é¡¹ç›®ç»“æ„å’Œ React é¡¹ç›®ä¸€æ¨¡ä¸€æ ·
```

```jsx
// å…¥å£æ–‡ä»¶ index.jsx
import { render } from 'solid-js/web'
import './index.css'
import App from './App'
const root = document.getElementById('root')
render(() => <App />, root)
```

#### å®˜æ–¹çš„è¿ç§»å»ºè®®
`Solid` çš„æ›´æ–°æ¨¡å‹ä¸ `React` å®Œå…¨ä¸åŒï¼Œç”šè‡³ä¸ `React + MobX` å®Œå…¨ä¸åŒ; ä¸è¦å°†å‡½æ•°ç»„ä»¶è§†ä¸º `render` å‡½æ•°ï¼Œè€Œæ˜¯å°†å®ƒä»¬è§†ä¸º `constructor`

åœ¨ `Solid` ä¸­ï¼Œ`props` å’Œ `store` æ˜¯ `proxy` å¯¹è±¡ï¼Œå®ƒä»¬ä¾èµ–äºå±æ€§è®¿é—®æ¥è¿›è¡Œè·Ÿè¸ªå’Œå“åº”å¼æ›´æ–°; æ³¨æ„è§£æ„æˆ–æå‰å±æ€§è®¿é—®ï¼Œè¿™å¯èƒ½å¯¼è‡´è¿™äº›å±æ€§å¤±å»ååº”æ€§æˆ–åœ¨é”™è¯¯çš„æ—¶é—´è§¦å‘

`Solid` çš„ `primitive` æ²¡æœ‰åƒ `Hook` è§„åˆ™è¿™æ ·çš„é™åˆ¶ï¼Œå› æ­¤æ‚¨å¯ä»¥éšæ„åµŒå¥—å®ƒä»¬

ä½ ä¸éœ€è¦ä½¿ç”¨åˆ—è¡¨è¡Œä¸Šçš„æ˜¾å¼ `key` æ¥å®ç°å…·æœ‰ `key` çš„è¡Œä¸º

åœ¨ `React` ä¸­ï¼Œæ¯å½“ä¿®æ”¹è¾“å…¥å­—æ®µæ—¶éƒ½ä¼šè§¦å‘ `onChange`ï¼Œä½†è¿™ä¸æ˜¯ `onChange` åŸç”Ÿå·¥ä½œçš„æ–¹å¼; åœ¨ `Solid` ä¸­ï¼Œä½¿ç”¨ `onInput` è®¢é˜…æ¯ä¸ªå€¼çš„æ›´æ”¹

## Props
{% notel green æœ¬æ®µå¯¼èˆª %}
{% btn `children`::#solid-children %} {% btn `mergeProps`::#solid-mergeProps %} {% btn `splitProps`::#solid-splitProps %}
{% endnotel %}

`Solid` çš„ç»„ä»¶ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°, å…¶å‚æ•°ä¹Ÿæ˜¯ `props`, ä½†**ä¸åº”é€šè¿‡è§£æ„ `props` æ¥è®¿é—®å±æ€§**, è€Œåº”å½“ç›´æ¥è®¿é—® `props` å¯¹è±¡ä»¥ç¡®ä¿å±æ€§çš„å“åº”æ€§

å¦‚æœè¦ä¼ é€’ç»™å­ç»„ä»¶çš„ `props` æ¯”è¾ƒå¤š, å¯ä»¥ä½¿ç”¨ `props` å¯¹è±¡å’Œå±•å¼€è¿ç®—ç¬¦ `{...props}` ä¼ é€’

#### children<i id="solid-children"></i>
`props.children` æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ `props`, ç”¨äºè®¿é—®ç»„ä»¶çš„å­ç»„ä»¶

`Solid` å¦‚æ­¤é«˜æ€§èƒ½çš„éƒ¨åˆ†åŸå› æ˜¯ `Solid` çš„ç»„ä»¶åŸºæœ¬ä¸Šåªæ˜¯å‡½æ•°è°ƒç”¨; è¿™æ„å‘³ç€è¿™äº› `props` ä¼šè¢«æƒ°æ€§æ±‚å€¼; `props` çš„è®¿é—®å°†è¢«æ¨è¿Ÿåˆ°æŸäº›åœ°æ–¹æœ‰ç”¨åˆ°å®ƒä»¬; è¿™ä¿ç•™äº†å“åº”æ€§ï¼Œè€Œä¸ä¼šå¼•å…¥æ— å…³çš„å°è£…ä»£ç æˆ–åŒæ­¥è¡Œä¸º; ç„¶è€Œï¼Œè¿™æ„å‘³ç€å­˜åœ¨å­ç»„ä»¶æˆ–å…ƒç´ çš„æƒ…å†µä¸‹ï¼Œé‡å¤è®¿é—®å¯èƒ½ä¼šå¯¼è‡´é‡æ–°åˆ›å»º

å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ åªæ˜¯å°†è¿™äº›å…¥å‚å±æ€§æ’å…¥åˆ° `JSX` ä¸­ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰é—®é¢˜; ä½†æ˜¯ç”±äº `children` å…ƒç´ å¯èƒ½ä¼šè¢«é‡å¤åˆ›å»ºï¼Œæ‰€ä»¥å½“ä½ å¤„ç† `children` æ—¶éœ€è¦æ ¼å¤–å°å¿ƒ

å‡ºäºè¿™ä¸ªåŸå› ï¼Œ`Solid` æä¾›äº† `children` å·¥å…·å‡½æ•°; æ­¤æ–¹æ³•æ—¢ä¼šæ ¹æ® `children` è®¿é—®åˆ›å»º `memo` ç¼“å­˜ï¼Œè¿˜ä¼šå¤„ç†ä»»ä½•åµŒå¥—çš„å­çº§å“åº”å¼å¼•ç”¨ï¼Œä»¥ä¾¿å¯ä»¥ç›´æ¥ä¸ `children` äº¤äº’

```jsx
// child.jsx
export default function ColoredList(props) {
  const c = children(() => props.children)
  createEffect(() => c().forEach(item => item.style.color = props.color))
  return <>{c()}</>
}
```

```jsx
// parent.jsx
import ColoredList from './child'

export default function App() {
  const [color, setColor] = createSignal("purple")

  return <>
    <ColoredList color={color()}>
      <For each={["Most", "Interesting", "Thing"]}>{item => <div>{item}</div>}</For>
    </ColoredList>
    <button onClick={() => setColor("teal")}>Set Color</button>
  </>
}
```

#### mergeProps<i id="solid-mergeProps"></i>
`mergeProps` å‡½æ•°ç”¨äºå°† `props` å¯¹è±¡ä¸å…¶ä»–å¯¹è±¡åˆå¹¶, å¹¶ç¡®ä¿ `props` å¯¹è±¡çš„å“åº”æ€§

```jsx
import { mergeProps } from 'solid-js'

export default function MyComponent(props) {
  const mergedProps = mergeProps(props, { className: 'my-class' })
  return <div {...mergedProps}>Hello, World!</div>
}
```

#### splitProps<i id="solid-splitProps"></i>
`splitProps` å‡½æ•°ç”¨äºå°† `props` å¯¹è±¡æ‹†åˆ†ä¸ºä¸¤ä¸ªå¯¹è±¡è€Œä¸å¤±å»å“åº”æ€§

```jsx
import { splitProps } from 'solid-js'

export default function MyComponent(props) {
  const [myProps, divProps] = splitProps(props, ['myProp'])
  return <div {...divProps}>Hello, World!</div>
}
```

## å“åº”å¼æ¥å£
### Signal<i id="solid-Signal"></i>
ç›¸å½“äº `React` çš„ `useState`ï¼Œä½†æ˜¯ `createSignal` è¿”å›çš„æ˜¯ `getter` å’Œ `setter`, å› æ­¤è¦ä½¿ç”¨æŸä¸ªå€¼, æ˜¯ `xxx()` è€Œä¸æ˜¯ `xxx`

```jsx
import { createSignal } from 'solid-js'

export default function Counter() {
  const [count, setCount] = createSignal(0)
  return (
    <div>
      {/* ä¼ å…¥æ–°å€¼ */}
      <button onClick={() => setCount(count() + 1)}>+</button>
      <span>{count()}</span>
      {/* ä¼ å…¥å‡½æ•° */}
      <button onClick={() => setCount(c => c - 1)}>-</button>
    </div>
  )
}
```

### Effect<i id="solid-Effect"></i>
ç›¸å½“äº `React` çš„ `useEffect`, ä½†ä¸éœ€è¦ä¼ å…¥ä¾èµ–é¡¹æ•°ç»„ (**å†…éƒ¨ç”¨åˆ°çš„ `Signal` ä¼šè‡ªåŠ¨æˆä¸ºä¾èµ–é¡¹**), ä¼šåœ¨æ¸²æŸ“å®Œæˆä¼šæ‰§è¡Œ

```jsx
import { createEffect } from 'solid-js'

export default function Counter() {
  const [count, setCount] = createSignal(0)
  createEffect(() => {
    console.log('count:', count())
  })
  return (
    <div>
      <button onClick={() => setCount(count() + 1)}>+</button>
      <span>{count()}</span>
      <button onClick={() => setCount(count() - 1)}>-</button>
    </div>
  )
}
```
  
### Memo<i id="solid-Memo"></i>
ç›¸å½“äº `React` çš„ `useMemo`, ä¼ å…¥ä¸€ä¸ªè®¡ç®—å‡½æ•° (åŒæ ·æ— éœ€ä¼ å…¥ä¾èµ–é¡¹æ•°ç»„), è¿”å›ä¸€ä¸ª `getter` å‡½æ•° (åªè¯»)

```jsx
// ä»¥è®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—ä¸ºä¾‹
import { createMemo, createSignal } from 'solid-js'

function fibonacci(n) {
  if (n <= 1) return n
  return fibonacci(n - 1) + fibonacci(n - 2)
}

// å¦‚æœä¸ç”¨ memo, æ¯æ¬¡ç‚¹å‡»æŒ‰é’®éƒ½ä¼šè®¡ç®— 5 æ¬¡æ–æ³¢é‚£å¥‘æ•°åˆ—
export function Fibonacci() {
  const [n, setN] = createSignal(0)
  const fib = () => fibonacci(n())
  return (
    <div>
      <input type="number" value={n()} onInput={e => setN(+e.target.value)} />
      <div>{fib()}{fib()}{fib()}{fib()}{fib()}</div>
    </div>
  )
}

// ä½¿ç”¨ memo, åªä¼šè®¡ç®—ä¸€æ¬¡
export function Fibonacci() {
  const [n, setN] = createSignal(0)
  const fib = createMemo(() => fibonacci(n()))
  return (
    <div>
      <input type="number" value={n()} onInput={e => setN(+e.target.value)} />
      <div>{fib()}{fib()}{fib()}{fib()}{fib()}</div>
    </div>
  )
}
```

### Store<i id="solid-Store"></i>
`Store` æ˜¯ `Solid` å¤„ç†åµŒå¥—å“åº”å¼çš„è§£å†³æ–¹æ¡ˆ; `Store` æ˜¯ä»£ç†å¯¹è±¡, å…¶å±æ€§å¯ä»¥è¢«è·Ÿè¸ª, å¹¶ä¸”å¯ä»¥åŒ…å«å…¶ä»–å¯¹è±¡, è¿™äº›å¯¹è±¡ä¼šè‡ªåŠ¨åŒ…è£…åœ¨ä»£ç†ä¸­, ç­‰ç­‰

ä¸ºäº†è®©äº‹æƒ…å˜å¾—ç®€å•, `Solid` åªä¸ºåœ¨è·Ÿè¸ªèŒƒå›´å†…è®¿é—®çš„å±æ€§åˆ›å»ºåº•å±‚ `Signal`; å› æ­¤, `Store` ä¸­çš„æ‰€æœ‰ `Signal` éƒ½æ˜¯æ ¹æ®è¦æ±‚å»¶è¿Ÿåˆ›å»ºçš„

```jsx
import { createStore } from 'solid-js/store'

const [store, setStore] = createStore({ todos: [] })
const addTodo = text => {
  setStore('todos', todos => [...todos, { id: ++todoId, text, completed: false }])
}
const toggleTodo = id => {
  setStore('todos', todo => todo.id === id, 'completed', completed => !completed)
}
```

#### produce
`produce` å‡½æ•°ç”¨äºåœ¨ `Store` ä¸­è¿›è¡Œå¤æ‚çš„æ›´æ–°, ç±»ä¼¼äº `useImmer`

```jsx
import { createStore, produce } from 'solid-js/store'

const [store, setStore] = createStore({ todos: [] })
const addTodo = text => {
  setStore('todos', produce(todos => {
    todos.push({ id: ++todoId, text, completed: false })
  }))
}
const toggleTodo = id => {
  setStore('todos', todo => todo.id === id, produce(todo => {
    todo.completed = !todo.completed
  }))
}
```

### Context<i id="solid-Context"></i>
`Context` æ˜¯ `Solid` çš„ä¸Šä¸‹æ–‡è§£å†³æ–¹æ¡ˆ, ç”¨äºåœ¨ç»„ä»¶æ ‘ä¸­ä¼ é€’æ•°æ®, è€Œä¸å¿…ä¸€çº§ä¸€çº§æ‰‹åŠ¨ä¼ é€’ `props`

`Context` ä¸ `React` çš„ `Context` ç±»ä¼¼, ä½†æ˜¯ `Solid` çš„ `Context` æ˜¯å“åº”å¼çš„, å› æ­¤å¯ä»¥åœ¨ `Context` ä¸­ä½¿ç”¨ `Signal` å’Œ `Store`

```jsx
// counter.jsx
import { createSignal, createContext, useContext } from 'solid-js'

const CounterContext = createContext()

export function CounterProvider(props) {
  const [count, setCount] = createSignal(props.count || 0)
  const store = [
    count,
    {
      increment() {
        setCount(c => c + 1);
      },
      decrement() {
        setCount(c => c - 1);
      }
    }
  ]
  return (
    <CounterContext.Provider value={store}>
      {props.children}
    </CounterContext.Provider>
  )
}

export function useCounter() { return useContext(CounterContext) }
```

```jsx
// app.jsx
import { CounterProvider, useCounter } from './counter'

export default function App() {
  const [count, { increment, decrement }] = useCounter()

  return (
    <CounterProvider count={10}>
      <h1>Welcome to Counter App</h1>
      <div>{count()}</div>
      <button onClick={increment}>+</button>
      <button onClick={decrement}>-</button>
    </CounterProvider>
  )
}
```

### Resource<i id="solid-Resource"></i>
`Resource` ç”¨äºå¤„ç†å¼‚æ­¥æ•°æ®, æœ‰ç‚¹åƒ `React` çš„ `useFormStatus` å’Œ `useActionState` çš„ç»“åˆ

```tsx
import { createResource, createSignal } from 'solid-js'

const fetchUser = async id => {
  const response = await fetch(`https://api.example.com/user/${id}`)
  return response.json()
}

export default function User() {
  const [userID, setUserID] = createSignal()
  const [user, { mutate, refetch }] = createResource(userID, fetchUser)

  return (
    <div>
      <input 
        type='number'
        onInput={e => setUserID(+e.target.value)}
      />

      // è¿™ä¸¤ä¸ªæ•°æ®è™½ç„¶ä¸æ˜¯å‡½æ•°è°ƒç”¨, ä½†æ˜¯ä¹Ÿæ˜¯å“åº”å¼çš„
      <p>{user.loading && 'Loading...'}</p>
      <p>{user.error && 'Error!'}</p>

      <div>
        // å¼€å§‹è¯·æ±‚æ•°æ®
        {user()}
      </div>

      // é‡æ–°è¯·æ±‚æ•°æ® (å³ä½¿ userID æ²¡æœ‰å˜åŒ–)
      <button onClick={refetch}>Refetch</button>

      // ç”¨ mutate æ›´æ–°æ•°æ®
      <button onClick={() => mutate(123456)}>Mutate</button>
    </div>
  )
}
```

## æµç¨‹æ§åˆ¶
{% notel green æœ¬æ®µå¯¼èˆª %}
{% btn `Show`::#solid-Show %} {% btn `For`::#solid-For %} {% btn `Index`::#solid-Index %} {% btn `Switch`::#solid-Switch %} {% btn `Dynamic`::#solid-Dynamic %} {% btn `Portal`::#solid-Portal %} {% btn `ErrorBoundary`::#solid-ErrorBoundary %}
{% endnotel %}

é™¤äº†åƒ `React` ä¸€æ ·çš„æ¡ä»¶æ¸²æŸ“å’Œå¾ªç¯æ¸²æŸ“, `Solid` è¿˜æä¾›äº†ä¸€äº›æ›´åŠ ç›´è§‚çš„æµç¨‹æ§åˆ¶ç»„ä»¶

#### Show<i id="solid-Show"></i>
`Show` æ˜¯ä¸€ä¸ªæ¡ä»¶æ¸²æŸ“ç»„ä»¶, æ¯”é€»è¾‘ä¸­æ–­å’Œä¸‰å…ƒè¡¨è¾¾å¼æ›´åŠ ç›´è§‚

```jsx
<Show 
  when={condition} 
  fallback={<div>æ¡ä»¶ä¸æ»¡è¶³æ—¶æ˜¾ç¤ºçš„å†…å®¹</div>}
>
  <div>æ¡ä»¶æ»¡è¶³æ—¶æ˜¾ç¤ºçš„å†…å®¹</div>
</Show>

// ç›¸å½“äº
{condition ? <div>æ¡ä»¶æ»¡è¶³æ—¶æ˜¾ç¤ºçš„å†…å®¹</div> : <div>æ¡ä»¶ä¸æ»¡è¶³æ—¶æ˜¾ç¤ºçš„å†…å®¹</div>}
```

#### For<i id="solid-For"></i>
`For` æ˜¯ä¸€ä¸ªå¾ªç¯æ¸²æŸ“ç»„ä»¶, å¯ä»¥ç”¨æ¥éå†æ•°ç»„æˆ–å¯¹è±¡; `index` æ˜¯ä¸€ä¸ª `Signal`, æ‰€ä»¥å°†åœ¨ç§»åŠ¨ `index` æ—¶é‡æ–°æ¸²æŸ“, è€Œ `item` ä¸æ˜¯

```jsx
<For 
  each={array} 
  fallback={<div>æ•°ç»„ä¸ºç©ºæ—¶æ˜¾ç¤ºçš„å†…å®¹</div>}
>
  {(item, index) => (
    <div>{index}: {item}</div>
  )}
</For>

// ç›¸å½“äº
const content = array.map((item, index) => <div>{index()}: {item}</div>)
{content.length ? content : <div>æ•°ç»„ä¸ºç©ºæ—¶æ˜¾ç¤ºçš„å†…å®¹</div>}
```

#### Index<i id="solid-Index"></i>
ç±»ä¼¼äº `For`, ä½† `index` ä¸æ˜¯ `Signal` è€Œ `item` æ˜¯

```jsx
<Index
  each={array}
  fallback={<div>æ•°ç»„ä¸ºç©ºæ—¶æ˜¾ç¤ºçš„å†…å®¹</div>}
>
  {(item, index) => (
    <div>{index}: {item()}</div>
  )}
</Index>
```

#### Switch<i id="solid-Switch"></i>
`Switch` ç”¨äºå¤„ç†å¤šä¸ªæ¡ä»¶çš„æƒ…å†µ (æ­¤æ—¶ç”¨ `Show` ä¼šæ˜¾å¾—å¾ˆè‡ƒè‚¿)

```jsx
<Switch
  fallback={<div>æ‰€æœ‰æ¡ä»¶éƒ½ä¸æ»¡è¶³æ—¶æ˜¾ç¤ºçš„å†…å®¹</div>}
>
  <Match when={condition1}>
    <div>æ¡ä»¶ 1 æ»¡è¶³æ—¶æ˜¾ç¤ºçš„å†…å®¹</div>
  </Match>
  <Match when={condition2}>
    <div>æ¡ä»¶ 2 æ»¡è¶³æ—¶æ˜¾ç¤ºçš„å†…å®¹</div>
  </Match>
  <Match when={condition3}>
    <div>æ¡ä»¶ 3 æ»¡è¶³æ—¶æ˜¾ç¤ºçš„å†…å®¹</div>
  </Match>
</Switch>
```

#### Dynamic<i id="solid-Dynamic"></i>
`<Dynamic>` æ ‡ç­¾å¤„ç†æ ¹æ®æ•°æ®æ¸²æŸ“æ—¶å¾ˆæœ‰ç”¨; `<Dynamic>` å¯ä»¥è®©ä½ å°†å…ƒç´ çš„å­—ç¬¦ä¸²æˆ–ç»„ä»¶å‡½æ•°ä¼ é€’ç»™å®ƒï¼Œå¹¶ä½¿ç”¨æä¾›çš„å…¶ä½™ `props` æ¥æ¸²æŸ“ç»„ä»¶

è¿™é€šå¸¸æ¯”ç¼–å†™å¤šä¸ª `<Show>` æˆ– `<Switch>` ç»„ä»¶æ›´ç®€ç»ƒ

```jsx
// ç”¨ Switch
<Switch fallback={<BlueThing />}>
  <Match when={selected() === "red"}>
    <RedThing />
  </Match>
  <Match when={selected() === "green"}>
    <GreenThing />
  </Match>
</Switch>

// ç”¨ Dynamic
<Dynamic component={options[selected()]} />
// options = { red: RedThing, green: GreenThing }
```

#### Portal<i id="solid-Portal"></i>
ç±»ä¼¼äº `<dialog open>`ï¼Œå¹¶ä¸”ä¼šæŠŠå…ƒç´ æå–å‡ºæ¥æ”¾åˆ° `body` ä¸­ï¼Œä»¥é¿å… `z-index` é—®é¢˜

```jsx
<Portal>
  <div>è¿™ä¸ª div ä¼šè¢«æ”¾åˆ° body ä¸­</div>
</Portal>
```

#### ErrorBoundary<i id="solid-ErrorBoundary"></i>
æºè‡ª `UI` çš„ `JavaScript` é”™è¯¯ä¸åº”ç ´åæ•´ä¸ªåº”ç”¨ç¨‹åº; é”™è¯¯è¾¹ç•Œ `ErrorBoundary` æ˜¯ä¸€ä¸ªå¯ä»¥æ•è·å­ç»„ä»¶æ ‘ä»»ä½•ä½ç½®äº§ç”Ÿçš„ `JavaScript` é”™è¯¯ï¼Œé”™è¯¯è¾¹ç•Œ `ErrorBoundary` ä¼šè®°å½•è¿™äº›é”™è¯¯ï¼Œå¹¶æ˜¾ç¤ºå›é€€ `UI` è€Œéå´©æºƒçš„ç»„ä»¶æ ‘

```jsx
<ErrorBoundary
  fallback={<div>å‡ºç°é”™è¯¯æ—¶æ˜¾ç¤ºçš„å†…å®¹</div>}
>
  <SomethingMightBroken />
</ErrorBoundary>
```

## ç”Ÿå‘½å‘¨æœŸ
{% notel green æœ¬æ®µå¯¼èˆª %}
{% btn `onMount`::#solid-onMount %} {% btn `onCleanup`::#solid-onCleanup %}
{% endnotel %}

`Solid` ä¸­åªæœ‰å°‘é‡çš„ç”Ÿå‘½å‘¨æœŸï¼Œå› ä¸ºä¸€åˆ‡çš„å­˜æ´»é”€æ¯éƒ½ç”±å“åº”ç³»ç»Ÿæ§åˆ¶; å“åº”ç³»ç»Ÿæ˜¯åŒæ­¥åˆ›å»ºå’Œæ›´æ–°çš„ï¼Œå› æ­¤å”¯ä¸€çš„è°ƒåº¦å°±æ˜¯å°†é€»è¾‘å†™åˆ°æ›´æ–°ç»“æŸçš„ `Effect` ä¸­

#### onMount<i id="solid-onMount"></i>
`onMount` å°±æ˜¯åªæ‰§è¡Œä¸€æ¬¡çš„ `Effect`, ç›¸å½“äº `useEffect(() => {}, [])` çš„å¼€å§‹é˜¶æ®µ

```jsx
import { onMount } from 'solid-js'

export default function Counter() {
  onMount(() => {
    console.log('mounted')
  })
  return (
    <div>
      Hello World
    </div>
  )
}
```

> å£°æ˜å‘¨æœŸä»…åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ, å› æ­¤å°†ä»£ç æ”¾åœ¨ `onMount` ä¼šè®©ä»–ä»¬åœ¨ `SSR` æ—¶ä¸ä¼šè¿è¡Œ

#### onCleanup<i id="solid-onCleanup"></i>
åœ¨ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥ä½¿ç”¨ `onCleanup`ï¼ŒåŒ…æ‹¬**ç»„ä»¶**å’Œ `Effect` ä¸­ï¼Œå®ƒä¼šåœ¨ç»„ä»¶é”€æ¯æˆ– `Effect` é‡æ–°è¿è¡Œæ—¶è¿è¡Œ

```jsx
import { onCleanup } from 'solid-js'

export default function Counter() {
  onCleanup(() => {
    console.log('cleaned up')
  })
  return (
    <div>
      Hello World
    </div>
  )
}
```

## ç»‘å®š
{% notel green æœ¬æ®µå¯¼èˆª %}
{% btn äº‹ä»¶::#solid-äº‹ä»¶ %} {% btn æ ·å¼::#solid-æ ·å¼ %} {% btn Ref::#solid-Ref %} {% btn `:use`::#solid-use %}
{% endnotel %}

#### äº‹ä»¶<i id="solid-äº‹ä»¶"></i>
```jsx
function App() {
  const [pos, setPos] = createSignal({x: 0, y: 0})

  function handleMouseMove(event) {
    setPos({
      x: event.clientX,
      y: event.clientY
    })
	}

  return (
    <div onMouseMove={handleMouseMove}>
      The mouse position is {pos().x} x {pos().y}
    </div>
  )
}
```

#### æ ·å¼<i id="solid-æ ·å¼"></i>
`Solid` ä¼ å…¥å¯¹è±¡è®¾ç½®æ ·å¼æ—¶, ä¸é‡‡ç”¨é©¼å³°å‘½åæ³•, è€Œæ˜¯ä¸ `CSS` ä¸€è‡´çš„çŸ­æ¨ªçº¿å‘½åæ³•

```jsx
<div 
  style={{ 
    color: 'red',
    'font-size': '20px',
    '--custom-color': '#333'
  }}
>
  Hello World
</div>
```

##### ç±»å
`Solid` æ”¯æŒä½¿ç”¨ `class` å’Œ `className` æ¥ä»¥å­—ç¬¦ä¸²å½¢å¼è®¾ç½®ç±»å; ä½†æä¾›äº†ä¸€ä¸ª `classList` å±æ€§, ç”¨äºä»¥å¯¹åƒ `{ 'class-name': isEnable, ... }` çš„å½¢å¼è®¾ç½®ç±»å

```jsx
// ä»¥å­—ç¬¦ä¸²å½¢å¼è®¾ç½®ç±»å
<div
  class={isEnable ? 'class-name' : ''}
></div>

// ä»¥å¯¹è±¡å½¢å¼è®¾ç½®ç±»å
<div
  classList={{
    'class-name': isEnable,
    'another-class-name': !isEnable
  }}
></div>
```

#### Ref<i id="solid-Ref"></i>
ç±»ä¼¼äº `React` çš„ `useRef`, ä½† `Solid` ä¸éœ€è¦å£°æ˜è¿™æ˜¯ä¸€ä¸ª `ref`, åªéœ€å°†ä»»æ„å˜é‡ä¼ é€’ç»™ç»„ä»¶çš„ `ref` å±æ€§å³å¯

```jsx
export default function App() {
  let ref
  return (
    <div>
      <span ref={ref}>Hello World</span>
      <button onClick={() => ref.textContent = 'Clicked'}>Click</button>
    </div>
  )
}
```

##### Forward Ref
`Solid` ä¹Ÿæ”¯æŒ `forwardRef`, ä½†æ˜¯**ä¸éœ€è¦**ä½¿ç”¨ `forwardRef` å‡½æ•°, åªéœ€å°† `ref` ä¼ é€’ç»™å­ç»„ä»¶, å­ç»„ä»¶é€šè¿‡ `props.ref` è·å– `ref` å¹¶ç»‘å®šåˆ°å…ƒç´ ä¸Šå³å¯

```jsx
function Child(props) {
  return <div ref={props.ref}>Hello World</div>
}

export default function App() {
  let ref
  return (
    <div>
      <Child ref={ref} />
      <button onClick={() => ref.textContent = 'Clicked'}>Click</button>
    </div>
  )
}
```

#### use:<i id="solid-use"></i>
`Solid` é€šè¿‡ `use:xxx` è¯­æ³•æ”¯æŒè‡ªå®šä¹‰æŒ‡ä»¤, å®é™…ä¸Šæ˜¯ `ref` çš„ä¸€ä¸ªè¯­æ³•ç³–, æ”¯æŒåœ¨åŒä¸€ä¸ªå…ƒç´ ä¸Šæœ‰å¤šä¸ªç»‘å®šè€Œä¸ä¼šå†²çª (å°±åƒ `addEventListener` ä¸€æ ·)

è‡ªå®šä¹‰æŒ‡ä»¤å‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•°: `element` å’Œ `valueAccesor`, `element` æ˜¯å½“å‰å…ƒç´ , `valueAccesor` æ˜¯ä¸€ä¸ªè·å–ç»‘å®šå€¼çš„å‡½æ•°

`use:` éœ€è¦è¢«ç¼–è¯‘å™¨æ£€æµ‹å¹¶è¿›è¡Œè½¬æ¢ï¼Œå¹¶ä¸”å‡½æ•°éœ€è¦åœ¨ä½œç”¨åŸŸå†…ï¼Œå› æ­¤ä¸èƒ½ä½œä¸ºä¼ å€¼çš„ä¸€éƒ¨åˆ†æˆ–åœ¨ç»„ä»¶ä¸Šä½¿ç”¨

```jsx
// App.jsx
import { createSignal, Show } from "solid-js"
import clickOutside from "./click-outside"

function App() {
  const [show, setShow] = createSignal(false)

  return (
    <Show
      when={show()}
      fallback={<button onClick={(e) => setShow(true)}>Open Modal</button>}
    >
      <div class="modal" use:clickOutside={() => setShow(false)}>
        Some Modal
      </div>
    </Show>
  )
}
```

```jsx
// click-outside.js
import { onCleanup } from "solid-js"

export default function clickOutside(el, accessor) {
  // accesor()?.() æ˜¯ä»€ä¹ˆé€†å¤©ä¸œè¥¿
  const onClick = (e) => !el.contains(e.target) && accessor()?.()

  document.body.addEventListener("click", onClick)

  onCleanup(() => document.body.removeEventListener("click", onClick))
}
```

## å“åº”æ€§
{% notel green æœ¬æ®µå¯¼èˆª %}
{% btn æ‰¹é‡æ›´æ–°::#solid-batch %} {% btn éšå¼è¯»å–::#solid-untrack %} {% btn æ˜¾å¼å£°æ˜Effectä¾èµ–::#solid-on %}
{% endnotel %}

#### æ‰¹é‡æ›´æ–°<i id="solid-batch"></i>
ä¸åŒäº `React` çš„ `setState`, `Solid` çš„ `setSignal` æ˜¯åŒæ­¥çš„, ä½†æ˜¯å¯ä»¥ä½¿ç”¨ `batch` å‡½æ•°æ¥è¿›è¡Œæ‰¹é‡æ›´æ–°

```tsx
import { createSignal, batch } from 'solid-js'

export default function Page() {
  const [firstName, setFirstName] = createSignal('John')
  const [lastName, setLastName] = createSignal('Doe')

  function handleClick() {
    batch(() => {
      setFirstName('Jane')
      setLastName('Smith')
    })
  }

  return (
    <div>
      <p>{firstName()} {lastName()}</p>
      <button onClick={handleClick}>Change Name</button>
    </div>
  )
}
```

#### éšå¼è¯»å–<i id="solid-untrack"></i>
`Solid` ä¼šè‡ªåŠ¨è·Ÿè¸ª `Signal` çš„è¯»å–, ä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬ä¸å¸Œæœ›è¿™æ ·, å¯ä»¥ä½¿ç”¨ `untrack` å‡½æ•°æ¥"æ‚„æ‚„åœ°"è¯»å– `Signal`

```tsx
import { createSignal, untrack } from 'solid-js'

export default function Page() {
  const [count, setCount] = createSignal(0)

  function handleClick() {
    untrack(() => {
      console.log(count())
    })
  }
  // å¦‚æœåªéœ€è¦å€¼, å¯ä»¥ç›´æ¥æŠŠ count ä¼ å…¥

  return (
    <div>
      <p>{count()}</p>
      <button onClick={handleClick}>Log Count</button>
    </div>
  )
}
```

#### æ˜¾å¼å£°æ˜ `Effect` ä¾èµ–<i id="solid-on"></i>
`Solid` çš„ `Effect` ä¼šè‡ªåŠ¨è·Ÿè¸ª `Signal` çš„è¯»å–, ä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬ä¸å¸Œæœ›è¿™æ ·, å¯ä»¥ä½¿ç”¨ `on` å‡½æ•°æ¥å£°æ˜ `Effect` çš„ä¾èµ–

```tsx
import { createSignal, on, createEffect } from 'solid-js'

export default function Page() {
  const [count, setCount] = createSignal(0)

  // æ¯æ¬¡ count å˜åŒ–éƒ½ä¼šè§¦å‘
  createEffect(() => {
    console.log(count())
  })
  // ç›¸å½“äº
  createEffect(on(count, (count) => {
    console.log(count())
  }))

  // åªåœ¨ count ç¬¬ä¸€æ¬¡å˜åŒ–æ—¶è§¦å‘
  createEffect(on(count, (count) => {
    console.log(count())
  }, { defer: true }))
  // æ³¨æ„: è¿™ä¸ªå¹¶ä¸å’Œ React çš„ useEffect ç­‰æ•ˆ
  // å› ä¸º solid å¯ä»¥ç›´æ¥æŠŠå‰¯ä½œç”¨å†™åœ¨ç»„ä»¶å‡½æ•°é‡Œ
  // ç»„ä»¶å‡½æ•°åªä¼šæ‰§è¡Œä¸€æ¬¡

  return (
    <div>
      <p>{count()}</p>
      <button onClick={() => setCount(count() + 1)}>Increment</button>
    </div>
  )
}
```

## å¼‚æ­¥
{% notel green æœ¬æ®µå¯¼èˆª %}
{% btn `lazy`::#solid-lazy %} {% btn `Suspense`::#solid-Suspense %} {% btn `SuspenseList`::#solid-SuspenseList %} {% btn `Transition`::#solid-Transition %}
{% endnotel %}

#### æ‡’åŠ è½½<i id="solid-lazy"></i>
`Solid` é€šè¿‡ `lazy` å‡½æ•°å®ç°ç»„ä»¶çš„æ‡’åŠ è½½

```tsx
// App.tsx
import { lazy } from 'solid-js'

const LazyComponent = lazy(() => import('./MyComponent'))

export default function App() {
  return (
    <div>
      <LazyComponent />
    </div>
  )
}
```

```tsx
// MyComponent.tsx
// æ³¨æ„: Solid çš„æ‡’åŠ è½½ç»„ä»¶å¿…é¡»æ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°
export default async function MyComponent() {
  await new Promise(resolve => setTimeout(resolve, 1000))
  return <div>Hello World</div>
}
```

#### Suspense<i id="solid-Suspense"></i>
åŒ `React` çš„ `Suspense`, å¤šç”¨äºæœåŠ¡ç«¯

```tsx
import { Suspense } from 'solid-js'

export default function App() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <LazyComponent />
    </Suspense>
  )
}
```

#### SuspenseList<i id="solid-SuspenseList"></i>
`SuspenseList` ç”¨äºç»„ç»‡æ§åˆ¶å¤šä¸ª `Suspense` ç»„ä»¶

```tsx
import { SuspenseList, Suspense } from 'solid-js'

export default function App() {
  return (
    // revealOrder:
    //   forwards: ä»å‰åˆ°å, backwards: ä»ååˆ°å‰, together: ç­‰å¾…æ‰€æœ‰ç»„ä»¶åŠ è½½å®Œæ¯•
    // tail:
    //   collapsed: ä¸€æ—¦æœ‰ä¸€ä¸ªç»„ä»¶åŠ è½½å®Œæ¯•, å°±ä¸å†æ˜¾ç¤ºåŠ è½½ä¸­çš„å†…å®¹
    //   hidden: ä¸€ç›´æ˜¾ç¤ºåŠ è½½ä¸­çš„å†…å®¹, ç›´åˆ°æ‰€æœ‰ç»„ä»¶åŠ è½½å®Œæ¯•
    <SuspenseList revealOrder='forwards' tail='collapsed'>
      <Suspense fallback={<div>Loading...</div>}>
        <LazyComponent />
      </Suspense>
      <Suspense fallback={<div>Loading...</div>}>
        <LazyComponent />
      </Suspense>
    </SuspenseList>
  )
}
```

#### Transition<i id="solid-Transition"></i>
`Transition` ç”¨äºå®ç°è¿‡æ¸¡åŠ¨ç”», ä»è€Œé¿å…åå¤æ˜¾ç¤º `fallback` å†…å®¹

```tsx
import { useTransition, createSignal } from 'solid-js'

export default function App() {
  const [show, setShow] = createSignal(false)
  const [pending, start] = useTransition()

  return (
    <div>
      <button onClick={() => start(() => setShow(!show()))}>Toggle</button>
      
      {pending() && <div>Loading...</div>}

      <div classList={{ show: show() }}>
        Hello World!
      </div>
    </div>
  )
}
```

# &#x2B50;SolidStart
å…¨æ ˆå¼€å‘æ¡†æ¶, ç±»ä¼¼äº `Next.js` ä¹‹äº `React`

```bash
# åˆ›å»ºé¡¹ç›®
bun create solid
# é¡¹ç›®ç»“æ„
- public # é™æ€èµ„æº
- src # å¯¼å…¥æ—¶å¯ç”¨ ~ ä»£æ›¿
  - routes # å¼€å‘æ‰€ç”¨ç›®å½•
    - index.tsx
  - entry-client.tsx # å®¢æˆ·ç«¯å…¥å£, æ— éœ€ä¿®æ”¹
  - entry-server.tsx # æœåŠ¡ç«¯å…¥å£, æ— éœ€ä¿®æ”¹
  - app.tsx # HTML å…¥å£
```

## ğŸš§ é¡µé¢è·¯ç”±

## ğŸš§ API è·¯ç”±

## ğŸš§ æ•°æ®è·å–

## ğŸš§ é¡µé¢æ•°æ®

## ğŸš§ è·¯ç”±é¢„åŠ è½½

## ğŸš§ é™æ€èµ„æº

## ğŸš§ ä¸­é—´ä»¶